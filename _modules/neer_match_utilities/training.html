

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>neer_match_utilities.training &mdash; Neer Match Utilities 1.1.6-beta documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/extra.css?v=503a7970" />
      <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.min.css" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=b6767a31"></script>
      <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
      <script src="https://cdn.datatables.net/2.1.8/js/dataTables.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Neer Match Utilities
              <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../install.html#pipy">PiPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../install.html#from-source">From Source</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../preparation.html">Data Preparation for Training</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../preparation.html#different-data-relationships">Different Data Relationships</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../preparation.html#loading-the-data">1. Loading the Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../preparation.html#inspecting-the-data">2. Inspecting the Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../preparation.html#simulating-a-many-to-many-relationship">3. Simulating a Many-to-Many Relationship</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../preparation.html#understanding-the-matching-issue">4. Understanding the Matching Issue</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../preparation.html#correcting-the-relationships">5. Correcting the Relationships</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../preparation.html#verifying-the-adjustments">6. Verifying the Adjustments</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../preparation.html#formatting">Formatting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../preparation.html#a-customized-similarity-map">1. A customized <code class="docutils literal notranslate"><span class="pre">similarity_map</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../preparation.html#harmonizing-the-data">2. Harmonizing the data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../preparation.html#re-structuring">Re-Structuring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../preparation.html#splitting-data">Splitting data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../model_save.html">Training and Saving a Model</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../model_save.html#prepare-the-data">Prepare the Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../model_save.html#train-the-model">Train the Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../model_save.html#export-the-model">Export the Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../model_save.html#export-performance-statistics">Export Performance Statistics</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../model_load.html">Loading a Model</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../model_load.html#load-data-model">Load Data &amp; Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../model_load.html#harmonize-format">Harmonize Format</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../model_load.html#make-suggestions">Make Suggestions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../id_generation.html">Creating a Common Identifier (ID)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../id_generation.html#between-two-sources">Between Two Sources</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../id_generation.html#load-data-model">1. Load Data &amp; Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../id_generation.html#harmonize-format">2. Harmonize Format</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../id_generation.html#generate-a-common-id">3. Generate a Common ID</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../id_generation.html#repeated-cross-sections-panel-id">Repeated Cross-Sections (Panel ID)</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../base.html">Base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model.html">Model</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../model.html#neer_match_utilities.model.EpochEndSaver"><code class="docutils literal notranslate"><span class="pre">EpochEndSaver</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../model.html#neer_match_utilities.model.EpochEndSaver.__init__"><code class="docutils literal notranslate"><span class="pre">EpochEndSaver.__init__()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../model.html#neer_match_utilities.model.EpochEndSaver.on_epoch_end"><code class="docutils literal notranslate"><span class="pre">EpochEndSaver.on_epoch_end()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../model.html#neer_match_utilities.model.Model"><code class="docutils literal notranslate"><span class="pre">Model</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../model.html#neer_match_utilities.model.Model.load"><code class="docutils literal notranslate"><span class="pre">Model.load()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../model.html#neer_match_utilities.model.Model.save"><code class="docutils literal notranslate"><span class="pre">Model.save()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../panel.html">Panel</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.GenerateID"><code class="docutils literal notranslate"><span class="pre">GenerateID</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.GenerateID.__init__"><code class="docutils literal notranslate"><span class="pre">GenerateID.__init__()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.GenerateID.assign_ids"><code class="docutils literal notranslate"><span class="pre">GenerateID.assign_ids()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.GenerateID.execute"><code class="docutils literal notranslate"><span class="pre">GenerateID.execute()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.GenerateID.generate_suggestions"><code class="docutils literal notranslate"><span class="pre">GenerateID.generate_suggestions()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.GenerateID.group_by_subgroups"><code class="docutils literal notranslate"><span class="pre">GenerateID.group_by_subgroups()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.GenerateID.harmonize_ids"><code class="docutils literal notranslate"><span class="pre">GenerateID.harmonize_ids()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.GenerateID.relations_left_right"><code class="docutils literal notranslate"><span class="pre">GenerateID.relations_left_right()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.SetupData"><code class="docutils literal notranslate"><span class="pre">SetupData</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.SetupData.matches"><code class="docutils literal notranslate"><span class="pre">SetupData.matches</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.SetupData.__init__"><code class="docutils literal notranslate"><span class="pre">SetupData.__init__()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.SetupData.adjust_overlap"><code class="docutils literal notranslate"><span class="pre">SetupData.adjust_overlap()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.SetupData.create_connected_groups"><code class="docutils literal notranslate"><span class="pre">SetupData.create_connected_groups()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.SetupData.data_preparation_panel"><code class="docutils literal notranslate"><span class="pre">SetupData.data_preparation_panel()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.SetupData.drop_repetitions"><code class="docutils literal notranslate"><span class="pre">SetupData.drop_repetitions()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.SetupData.panel_preparation"><code class="docutils literal notranslate"><span class="pre">SetupData.panel_preparation()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../prepare.html">Prepare</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../prepare.html#neer_match_utilities.prepare.Prepare"><code class="docutils literal notranslate"><span class="pre">Prepare</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../prepare.html#neer_match_utilities.prepare.Prepare.__init__"><code class="docutils literal notranslate"><span class="pre">Prepare.__init__()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../prepare.html#neer_match_utilities.prepare.Prepare.do_remove_stop_words"><code class="docutils literal notranslate"><span class="pre">Prepare.do_remove_stop_words()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../prepare.html#neer_match_utilities.prepare.Prepare.format"><code class="docutils literal notranslate"><span class="pre">Prepare.format()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../prepare.html#neer_match_utilities.prepare.similarity_map_to_dict"><code class="docutils literal notranslate"><span class="pre">similarity_map_to_dict()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../prepare.html#neer_match_utilities.prepare.synth_mismatches"><code class="docutils literal notranslate"><span class="pre">synth_mismatches()</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../split.html">Split</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../split.html#neer_match_utilities.split.SplitError"><code class="docutils literal notranslate"><span class="pre">SplitError</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../split.html#neer_match_utilities.split.split_test_train"><code class="docutils literal notranslate"><span class="pre">split_test_train()</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../training.html">Training</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../training.html#neer_match_utilities.training.Training"><code class="docutils literal notranslate"><span class="pre">Training</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../training.html#neer_match_utilities.training.Training.evaluate_dataframe"><code class="docutils literal notranslate"><span class="pre">Training.evaluate_dataframe()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../training.html#neer_match_utilities.training.Training.matches_reorder"><code class="docutils literal notranslate"><span class="pre">Training.matches_reorder()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../training.html#neer_match_utilities.training.Training.performance_statistics_export"><code class="docutils literal notranslate"><span class="pre">Training.performance_statistics_export()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../training.html#neer_match_utilities.training.TrainingPipe"><code class="docutils literal notranslate"><span class="pre">TrainingPipe</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../training.html#neer_match_utilities.training.TrainingPipe.WarmupCosine"><code class="docutils literal notranslate"><span class="pre">TrainingPipe.WarmupCosine</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../training.html#neer_match_utilities.training.TrainingPipe.WarmupCosine.__init__"><code class="docutils literal notranslate"><span class="pre">TrainingPipe.WarmupCosine.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../training.html#neer_match_utilities.training.TrainingPipe.WarmupCosine.from_config"><code class="docutils literal notranslate"><span class="pre">TrainingPipe.WarmupCosine.from_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../training.html#neer_match_utilities.training.TrainingPipe.__init__"><code class="docutils literal notranslate"><span class="pre">TrainingPipe.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../training.html#neer_match_utilities.training.alpha_balanced"><code class="docutils literal notranslate"><span class="pre">alpha_balanced()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../training.html#neer_match_utilities.training.combined_loss"><code class="docutils literal notranslate"><span class="pre">combined_loss()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../training.html#neer_match_utilities.training.focal_loss"><code class="docutils literal notranslate"><span class="pre">focal_loss()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../training.html#neer_match_utilities.training.soft_f1_loss"><code class="docutils literal notranslate"><span class="pre">soft_f1_loss()</span></code></a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">License</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../LICENSE.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Neer Match Utilities</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">neer_match_utilities.training</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for neer_match_utilities.training</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">SuperClass</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">neer_match.similarity_map</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimilarityMap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neer_match.matching_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">DLMatchingModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neer_match_utilities.baseline_io</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelBaseline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neer_match_utilities.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">EpochEndSaver</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dill</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tensorflow.keras.backend</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">K</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tensorflow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tf</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>



<div class="viewcode-block" id="Training">
<a class="viewcode-back" href="../../training.html#neer_match_utilities.training.Training">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Training</span><span class="p">(</span><span class="n">SuperClass</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for managing and evaluating training processes, including </span>
<span class="sd">    reordering matches, evaluating performance metrics, and exporting models.</span>

<span class="sd">    Inherits:</span>
<span class="sd">    ---------</span>
<span class="sd">    SuperClass : Base class providing shared attributes and methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Training.matches_reorder">
<a class="viewcode-back" href="../../training.html#neer_match_utilities.training.Training.matches_reorder">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">matches_reorder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matches</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">matches_id_left</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">matches_id_right</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reorders a matches DataFrame to include indices from the left and </span>
<span class="sd">        right DataFrames instead of their original IDs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        matches : pd.DataFrame</span>
<span class="sd">            DataFrame containing matching pairs.</span>
<span class="sd">        matches_id_left : str</span>
<span class="sd">            Column name in the `matches` DataFrame corresponding to the left IDs.</span>
<span class="sd">        matches_id_right : str</span>
<span class="sd">            Column name in the `matches` DataFrame corresponding to the right IDs.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            A DataFrame with columns `left` and `right`, representing the indices</span>
<span class="sd">            of matching pairs in the left and right DataFrames.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Create local copies of the original dataframes</span>
        <span class="n">df_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_left</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_right</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


        <span class="c1"># Add custom indices</span>
        <span class="n">df_left</span><span class="p">[</span><span class="s1">&#39;index_left&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_left</span><span class="o">.</span><span class="n">index</span>
        <span class="n">df_right</span><span class="p">[</span><span class="s1">&#39;index_right&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_right</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># Combine the datasets into one</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">df_left</span><span class="p">,</span> 
            <span class="n">matches</span><span class="p">,</span> 
            <span class="n">left_on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_left</span><span class="p">,</span> 
            <span class="n">right_on</span><span class="o">=</span><span class="n">matches_id_left</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
            <span class="n">validate</span><span class="o">=</span><span class="s1">&#39;1:m&#39;</span><span class="p">,</span>
            <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_l&#39;</span><span class="p">,</span> <span class="s1">&#39;_r&#39;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span>
            <span class="n">df_right</span><span class="p">,</span>
            <span class="n">left_on</span><span class="o">=</span><span class="n">matches_id_right</span><span class="p">,</span>
            <span class="n">right_on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_right</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
            <span class="n">validate</span><span class="o">=</span><span class="s1">&#39;m:1&#39;</span><span class="p">,</span>
            <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_l&#39;</span><span class="p">,</span> <span class="s1">&#39;_r&#39;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Extract and rename index columns</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;index_left&#39;</span><span class="p">,</span> <span class="s1">&#39;index_right&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;index_left&#39;</span><span class="p">:</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;index_right&#39;</span><span class="p">:</span> <span class="s1">&#39;right&#39;</span>
            <span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">matches</span> <span class="o">=</span> <span class="n">matches</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">matches</span></div>


<div class="viewcode-block" id="Training.evaluate_dataframe">
<a class="viewcode-back" href="../../training.html#neer_match_utilities.training.Training.evaluate_dataframe">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evaluation_test</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">evaluation_train</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combines and evaluates test and training performance metrics.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        evaluation_test : dict</span>
<span class="sd">            Dictionary containing performance metrics for the test dataset.</span>
<span class="sd">        evaluation_train : dict</span>
<span class="sd">            Dictionary containing performance metrics for the training dataset.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            A DataFrame with accuracy, precision, recall, F-score, and a timestamp</span>
<span class="sd">            for both test and training datasets.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create DataFrames for test and training metrics</span>
        <span class="n">df_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">evaluation_test</span><span class="p">])</span>
        <span class="n">df_test</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">])</span>

        <span class="n">df_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">evaluation_train</span><span class="p">])</span>
        <span class="n">df_train</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">])</span>

        <span class="c1"># Concatenate and calculate metrics</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_test</span><span class="p">,</span> <span class="n">df_train</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="Training.performance_statistics_export">
<a class="viewcode-back" href="../../training.html#neer_match_utilities.training.Training.performance_statistics_export">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">performance_statistics_export</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">target_directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">evaluation_train</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">evaluation_test</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">export_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Exports performance metrics + similarity map (as before).</span>
<span class="sd">        Optionally also saves the model:</span>
<span class="sd">          - DL/NS via Model.save</span>
<span class="sd">          - baseline via ModelBaseline.save</span>

<span class="sd">        Default behavior remains unchanged because export_model defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Construct the full path for the model directory</span>
        <span class="n">model_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">target_directory</span><span class="p">)</span> <span class="o">/</span> <span class="n">model_name</span>
        <span class="n">model_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># -----------------------------</span>
        <span class="c1"># 1) Save performance metrics</span>
        <span class="c1"># -----------------------------</span>
        <span class="k">if</span> <span class="n">evaluation_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">evaluation_train</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df_evaluate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_dataframe</span><span class="p">(</span><span class="n">evaluation_test</span><span class="p">,</span> <span class="n">evaluation_train</span><span class="p">)</span>
            <span class="n">df_evaluate</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">model_dir</span> <span class="o">/</span> <span class="s2">&quot;performance.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performance metrics saved to </span><span class="si">{</span><span class="n">model_dir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;performance.csv&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># -----------------------------</span>
        <span class="c1"># 2) Save similarity map (same behavior as before)</span>
        <span class="c1"># -----------------------------</span>
        <span class="c1"># store exactly what was used to build SimilarityMap</span>
        <span class="c1"># (usually a dict mapping field -&gt; [metrics])</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_dir</span> <span class="o">/</span> <span class="s2">&quot;similarity_map.dill&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">dill</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">similarity_map</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Similarity map saved to </span><span class="si">{</span><span class="n">model_dir</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;similarity_map.dill&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># -----------------------------</span>
        <span class="c1"># 3) Optionally export model</span>
        <span class="c1"># -----------------------------</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">export_model</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># If it&#39;s a statsmodels baseline (Logit/Probit): has .result</span>
        <span class="c1"># If it&#39;s sklearn baseline (GB): saved via ModelBaseline too</span>
        <span class="n">is_baseline</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;result&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;GradientBoostingModel&quot;</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">is_baseline</span><span class="p">:</span>
            <span class="n">ModelBaseline</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">target_directory</span><span class="o">=</span><span class="n">target_directory</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">model_name</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Baseline model saved to </span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">target_directory</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">model_name</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;model&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Fall back to existing DL/NS saver</span>
        <span class="c1"># (This preserves old behavior unless you set export_model=True.)</span>
        <span class="n">Model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">target_directory</span><span class="o">=</span><span class="n">target_directory</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">model_name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DL/NS model saved to </span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">target_directory</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">model_name</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;model&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="focal_loss">
<a class="viewcode-back" href="../../training.html#neer_match_utilities.training.focal_loss">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">focal_loss</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Focal Loss function for binary classification tasks.</span>

<span class="sd">    Focal Loss is designed to address class imbalance by assigning higher weights</span>
<span class="sd">    to the minority class and focusing the model&#39;s learning on hard-to-classify examples.</span>
<span class="sd">    It reduces the loss contribution from well-classified examples, making it</span>
<span class="sd">    particularly effective for imbalanced datasets.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    alpha : float, optional, default=0.75</span>
<span class="sd">        Weighting factor for the positive class (minority class).</span>

<span class="sd">        - Must be in the range [0, 1].</span>
<span class="sd">        - A higher value increases the loss contribution from the positive class</span>
<span class="sd">          (underrepresented class) relative to the negative class (overrepresented class).</span>

<span class="sd">    gamma : float, optional, default=2.0</span>
<span class="sd">        Focusing parameter that reduces the loss contribution from easy examples.</span>

<span class="sd">        - ``gamma = 0``: No focusing, equivalent to Weighted Binary Cross-Entropy Loss (if alpha is set to 0.5).</span>
<span class="sd">        - ``gamma &gt; 0``: Focuses more on hard-to-classify examples.</span>
<span class="sd">        - Larger values emphasize harder examples more strongly.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    loss : callable</span>
<span class="sd">        A loss function that computes the focal loss given the true labels (`y_true`)</span>
<span class="sd">        and predicted probabilities (`y_pred`).</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If `alpha` is not in the range [0, 1].</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - The positive class (minority or underrepresented class) is weighted by `alpha`.</span>
<span class="sd">    - The negative class (majority or overrepresented class) is automatically weighted</span>
<span class="sd">      by ``1 - alpha``.</span>
<span class="sd">    - Ensure `alpha` is set appropriately to reflect the level of imbalance in the dataset.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    Lin, T.-Y., Goyal, P., Girshick, R., He, K., &amp; Doll√°r, P. (2017).</span>
<span class="sd">    Focal Loss for Dense Object Detection. In ICCV.</span>

<span class="sd">    Explanation of Key Terms</span>
<span class="sd">    -------------------------</span>
<span class="sd">    - **Positive Class (Underrepresented):**</span>

<span class="sd">      - Refers to the class with fewer examples in the dataset.</span>
<span class="sd">      - Typically weighted by `alpha`, which should be greater than 0.5 in highly imbalanced datasets.</span>

<span class="sd">    - **Negative Class (Overrepresented):**</span>

<span class="sd">      - Refers to the class with more examples in the dataset.</span>
<span class="sd">      - Its weight is automatically ``1 - alpha``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">alpha</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Parameter `alpha` must be in the range [0, 1].&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
        <span class="c1"># numerical safety</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">epsilon</span><span class="p">()</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span>

        <span class="c1"># per-example alpha: alpha for positive, (1-alpha) for negative</span>
        <span class="n">alpha_t</span> <span class="o">=</span> <span class="n">y_true</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">y_true</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span>

        <span class="c1"># p_t is the prob of the true class</span>
        <span class="n">p_t</span> <span class="o">=</span> <span class="n">y_true</span> <span class="o">*</span> <span class="n">y_pred</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">y_true</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span>

        <span class="c1"># BCE equals -log(p_t) when reduced per-example</span>
        <span class="n">bce</span> <span class="o">=</span> <span class="o">-</span><span class="n">K</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p_t</span><span class="p">)</span>

        <span class="c1"># focal modulation and weighting</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="n">alpha_t</span> <span class="o">*</span> <span class="n">K</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">p_t</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span> <span class="o">*</span> <span class="n">bce</span>
        <span class="k">return</span> <span class="n">K</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">loss</span></div>



<div class="viewcode-block" id="soft_f1_loss">
<a class="viewcode-back" href="../../training.html#neer_match_utilities.training.soft_f1_loss">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">soft_f1_loss</span><span class="p">(</span><span class="n">epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-7</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Soft F1 Loss for imbalanced binary classification tasks.</span>

<span class="sd">    Soft F1 Loss provides a differentiable approximation of the F1 score,</span>
<span class="sd">    combining precision and recall into a single metric. By optimizing</span>
<span class="sd">    this loss, models are encouraged to balance false positives and false</span>
<span class="sd">    negatives, which is especially useful when classes are imbalanced.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    epsilon : float, optional, default=1e-7</span>
<span class="sd">        Small constant added to numerator and denominator to avoid division</span>
<span class="sd">        by zero and stabilize training. Must be &gt; 0.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    loss : callable</span>
<span class="sd">        A loss function that takes true labels (`y_true`) and predicted</span>
<span class="sd">        probabilities (`y_pred`) and returns `1 - soft_f1`, so that</span>
<span class="sd">        minimizing this loss maximizes the soft F1 score.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If `epsilon` is not strictly positive.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - True positives (TP), false positives (FP), and false negatives (FN)</span>
<span class="sd">      are computed in a ‚Äúsoft‚Äù (differentiable) manner by summing over</span>
<span class="sd">      probabilities rather than thresholded predictions.</span>
<span class="sd">    - Soft F1 = (2¬∑TP + Œµ) / (2¬∑TP + FP + FN + Œµ).</span>
<span class="sd">    - Loss = 1 ‚àí Soft F1, which ranges from 0 (perfect) to 1 (worst).</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    - B√©n√©dict, G., Koops, V., Odijk D., &amp; de Rijke M. (2021). SigmoidF1: A </span>
<span class="sd">      Smooth F1 Score Surrogate Loss for Multilabel Classification. *arXiv 2108.10566*.</span>

<span class="sd">    Explanation of Key Terms</span>
<span class="sd">    ------------------------</span>
<span class="sd">    - **True Positives (TP):** Sum of predicted probabilities for actual</span>
<span class="sd">      positive examples.</span>
<span class="sd">    - **False Positives (FP):** Sum of predicted probabilities assigned to</span>
<span class="sd">      negative examples.</span>
<span class="sd">    - **False Negatives (FN):** Sum of (1 ‚àí predicted probability) for</span>
<span class="sd">      positive examples.</span>
<span class="sd">    - **Œµ (epsilon):** Stabilizer to prevent division by zero when TP, FP,</span>
<span class="sd">      and FN are all zero.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ```python</span>
<span class="sd">    loss_fn = soft_f1_loss(epsilon=1e-6)</span>
<span class="sd">    y_true = tf.constant([[1, 0, 1]], dtype=tf.float32)</span>
<span class="sd">    y_pred = tf.constant([[0.9, 0.2, 0.7]], dtype=tf.float32)</span>
<span class="sd">    loss_value = loss_fn(y_true, y_pred)</span>
<span class="sd">    print(loss_value.numpy())  # e.g. 0.1‚Ä¶</span>
<span class="sd">    ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
        <span class="n">y_true</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">clip_by_value</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">epsilon</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">epsilon</span><span class="p">)</span>

        <span class="c1"># Soft counts</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">y_pred</span> <span class="o">*</span> <span class="n">y_true</span><span class="p">)</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">y_pred</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_true</span><span class="p">))</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span> <span class="o">*</span> <span class="n">y_true</span><span class="p">)</span>

        <span class="c1"># Denominator</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">tp</span> <span class="o">+</span> <span class="n">fp</span> <span class="o">+</span> <span class="n">fn</span> <span class="o">+</span> <span class="n">epsilon</span>

        <span class="c1"># Avoid NaNs from 0/0</span>
        <span class="n">soft_f1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">denom</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">tp</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>

        <span class="n">loss_val</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">soft_f1</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">is_finite</span><span class="p">(</span><span class="n">loss_val</span><span class="p">),</span> <span class="n">loss_val</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">loss</span></div>



<div class="viewcode-block" id="combined_loss">
<a class="viewcode-back" href="../../training.html#neer_match_utilities.training.combined_loss">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">combined_loss</span><span class="p">(</span>
    <span class="n">weight_f1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-7</span><span class="p">,</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.99</span><span class="p">,</span>
    <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combined loss: weighted sum of Soft F1 loss and Focal Loss for imbalanced binary classification.</span>

<span class="sd">    This loss blends the advantages of a differentiable F1-based objective (which balances</span>
<span class="sd">    precision and recall) with the sample-focusing property of Focal Loss (which down-weights</span>
<span class="sd">    easy examples). By tuning ``weight_f1``, you can interpolate between solely optimizing</span>
<span class="sd">    for F1 score (when ``weight_f1 = 1.0``) and solely focusing on hard examples via focal loss</span>
<span class="sd">    (when ``weight_f1 = 0.0``).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weight_f1 : float, default=0.5</span>
<span class="sd">        Mixing coefficient in ``[0, 1]``.</span>
<span class="sd">        - ``weight_f1 = 1.0``: optimize only Soft F1 loss.</span>
<span class="sd">        - ``weight_f1 = 0.0``: optimize only Focal Loss.</span>
<span class="sd">        - Intermediate values blend the two objectives proportionally.</span>
<span class="sd">    epsilon : float, default=1e-7</span>
<span class="sd">        Small stabilizer for Soft F1 calculation. Must be ``&gt; 0``.</span>
<span class="sd">    alpha : float, default=0.25</span>
<span class="sd">        Balancing factor for Focal Loss, weighting the positive (minority) class.</span>
<span class="sd">        Must lie in ``[0, 1]``.</span>
<span class="sd">    gamma : float, default=2.0</span>
<span class="sd">        Focusing parameter for Focal Loss.</span>
<span class="sd">        - ``gamma = 0`` reduces to weighted BCE.</span>
<span class="sd">        - Larger ``gamma`` emphasizes harder (misclassified) examples.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    callable</span>
<span class="sd">        A function ``loss(y_true, y_pred)`` that computes</span>

<span class="sd">        .. math::</span>

<span class="sd">           \\text{CombinedLoss}</span>
<span class="sd">           = \\text{weight\\_f1} \\cdot \\text{SoftF1}(y, \\hat{y};\\,\\varepsilon)</span>
<span class="sd">             + (1 - \\text{weight\\_f1}) \\cdot \\text{FocalLoss}(y, \\hat{y};\\,\\alpha, \\gamma).</span>

<span class="sd">        Minimizing this combined loss encourages both a high F1 score</span>
<span class="sd">        and focus on hard-to-classify samples.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If ``weight_f1`` is not in ``[0, 1]``, or if ``epsilon &lt;= 0``, or if ``alpha`` is not</span>
<span class="sd">        in ``[0, 1]``, or if ``gamma &lt; 0``.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    - **Soft F1 loss**: ``1 - \\text{SoftF1}``, where</span>

<span class="sd">      .. math::</span>

<span class="sd">         \\text{SoftF1} = \\frac{2\\,TP + \\varepsilon}{2\\,TP + FP + FN + \\varepsilon}.</span>

<span class="sd">      Here ``TP``, ``FP``, and ``FN`` are *soft* counts computed from probabilities.</span>
<span class="sd">    - **Focal Loss** down-weights well-classified examples to focus learning on difficult cases.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    - Lin, T.-Y., Goyal, P., Girshick, R., He, K., &amp; Doll√°r, P. (2017).</span>
<span class="sd">      Focal Loss for Dense Object Detection. *ICCV*.</span>
<span class="sd">    - B√©n√©dict, G., Koops, V., Odijk, D., &amp; de Rijke, M. (2021).</span>
<span class="sd">      SigmoidF1: A Smooth F1 Score Surrogate Loss for Multilabel Classification. *arXiv:2108.10566*.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    .. code-block:: python</span>

<span class="sd">       import tensorflow as tf</span>
<span class="sd">       loss_fn = combined_loss(weight_f1=0.5, epsilon=1e-6, alpha=0.25, gamma=2.0)</span>

<span class="sd">       y_true = tf.constant([[1, 0, 1]], dtype=tf.float32)</span>
<span class="sd">       y_pred = tf.constant([[0.9, 0.2, 0.7]], dtype=tf.float32)</span>

<span class="sd">       value = loss_fn(y_true, y_pred)</span>
<span class="sd">       print(&quot;Combined loss:&quot;, float(value.numpy()))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate hyper-parameters</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">weight_f1</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`weight_f1` must be in [0, 1].&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">epsilon</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`epsilon` must be strictly positive.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">alpha</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`alpha` must be in [0, 1].&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gamma</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`gamma` must be non-negative.&quot;</span><span class="p">)</span>

    <span class="c1"># Instantiate the individual losses</span>
    <span class="n">f1_fn</span>   <span class="o">=</span> <span class="n">soft_f1_loss</span><span class="p">(</span><span class="n">epsilon</span><span class="p">)</span>
    <span class="n">focal_fn</span> <span class="o">=</span> <span class="n">focal_loss</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
        <span class="c1"># Weighted combination</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">weight_f1</span> <span class="o">*</span> <span class="n">f1_fn</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">weight_f1</span><span class="p">)</span> <span class="o">*</span> <span class="n">focal_fn</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">loss</span></div>


<div class="viewcode-block" id="alpha_balanced">
<a class="viewcode-back" href="../../training.html#neer_match_utilities.training.alpha_balanced">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">alpha_balanced</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">matches</span><span class="p">,</span> <span class="n">mismatch_share</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">max_alpha</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute Œ± so that Œ±*N_pos = (1-Œ±)*N_neg.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    left, right : pandas.DataFrame</span>
<span class="sd">    matches     : pandas.DataFrame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Œ± in [0,1] for focal loss (positive-class weight).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N_pos</span>   <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>
    <span class="n">N_neg</span>   <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">right</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>

    <span class="n">alpha</span>   <span class="o">=</span> <span class="p">(</span><span class="n">mismatch_share</span> <span class="o">*</span> <span class="n">N_neg</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">mismatch_share</span> <span class="o">*</span> <span class="n">N_neg</span> <span class="o">+</span> <span class="n">N_pos</span><span class="p">)</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">max_alpha</span><span class="p">)</span>

    <span class="n">N_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">N_total</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Total number of pairs is zero.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">alpha</span></div>



<div class="viewcode-block" id="TrainingPipe">
<a class="viewcode-back" href="../../training.html#neer_match_utilities.training.TrainingPipe">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TrainingPipe</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Orchestrates the full training and evaluation process of a deep learning</span>
<span class="sd">    record-linkage model using a user-supplied similarity map and preprocessed data.</span>

<span class="sd">    The class handles both training phases (soft-F1 pretraining and focal-loss fine-tuning),</span>
<span class="sd">    dynamic learning-rate scheduling, and automatic weight-decay adaptation. It also exports</span>
<span class="sd">    checkpoints, final models, and evaluation statistics for reproducibility.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    model_name : str</span>
<span class="sd">        Name assigned to the trained model. A corresponding subdirectory is created</span>
<span class="sd">        under the project directory to store checkpoints and exports.</span>

<span class="sd">    training_data : tuple or dict</span>
<span class="sd">        Preprocessed training data in one of the following formats:</span>
<span class="sd">        - Tuple: (left_train, right_train, matches_train)</span>
<span class="sd">        - Dict: {&quot;left&quot;: left_train, &quot;right&quot;: right_train, &quot;matches&quot;: matches_train}</span>

<span class="sd">    testing_data : tuple or dict</span>
<span class="sd">        Preprocessed testing data in one of the following formats:</span>
<span class="sd">        - Tuple: (left_test, right_test, matches_test)</span>
<span class="sd">        - Dict: {&quot;left&quot;: left_test, &quot;right&quot;: right_test, &quot;matches&quot;: matches_test}</span>

<span class="sd">    similarity_map : dict</span>
<span class="sd">        User-defined similarity configuration mapping variable names to similarity measures.</span>
<span class="sd">        Must follow the format accepted by `SimilarityMap`.</span>

<span class="sd">    id_left_col : str, optional</span>
<span class="sd">        Name of the unique identifier column in the left DataFrames</span>
<span class="sd">        (`left_train` and `left_test`).</span>
<span class="sd">        The ID column is used internally to index entities and to align</span>
<span class="sd">        training labels. Defaults to `&quot;id_unique&quot;`.</span>

<span class="sd">    id_right_col : str, optional</span>
<span class="sd">        Name of the unique identifier column in the right DataFrames</span>
<span class="sd">        (`right_train` and `right_test`).</span>
<span class="sd">        The ID column is used internally to index entities and to align</span>
<span class="sd">        training labels. Defaults to `&quot;id_unique&quot;`.</span>

<span class="sd">    no_tm_pbatch : int</span>
<span class="sd">        Target number of positive (matching) pairs per batch. Used to adapt batch size</span>
<span class="sd">        dynamically via the `required_batch_size` heuristic.</span>

<span class="sd">    save_architecture: bool, optional</span>
<span class="sd">        Whether to save the model architecture in an image alongside weights when exporting.</span>
<span class="sd">        Requires binaries of of graphviz to be installed. Otherwise, the code breaks.</span>
<span class="sd">        Defaults to `False`.</span>

<span class="sd">    stage_1 : bool, optional</span>
<span class="sd">        Whether to run the first training stage (soft-F1 pretraining).  </span>
<span class="sd">        If False, the arguments `epochs_1` and `mismatch_share_1` are not required</span>
<span class="sd">        and will be ignored.</span>

<span class="sd">    stage_2 : bool, optional</span>
<span class="sd">        Whether to run the second training stage (focal-loss fine-tuning).  </span>
<span class="sd">        If False, the arguments `epochs_2`, `mismatch_share_2`, `no_tm_pbatch`,</span>
<span class="sd">        `gamma`, and `max_alpha` are not required and will be ignored.</span>

<span class="sd">    epochs_1 : int, optional</span>
<span class="sd">        Number of training epochs during the first phase (soft-F1 pretraining).</span>
<span class="sd">        Required only when `stage_1=True`.</span>

<span class="sd">    mismatch_share_1 : float, optional</span>
<span class="sd">        Fraction of all possible negative (non-matching) pairs used during Round 1.</span>
<span class="sd">        Required only when `stage_1=True`.</span>

<span class="sd">    stage1_loss : str or callable, optional</span>
<span class="sd">        Loss function used during Stage 1 (pretraining).  </span>
<span class="sd">        By default, this is ``soft_f1_loss()``, reproducing the original NeerMatch</span>
<span class="sd">        behavior.  </span>

<span class="sd">        The argument accepts either:</span>

<span class="sd">        - A **string** specifying a built-in or predefined loss:</span>
<span class="sd">            * ``&quot;soft_f1&quot;`` ‚Äî use the standard soft-F1 loss (default)</span>
<span class="sd">            * ``&quot;binary_crossentropy&quot;`` ‚Äî use wrapped binary crossentropy</span>
<span class="sd">            (internally adapted for NeerMatch‚Äôs evaluation loop)</span>

<span class="sd">        - A **callable loss function**, allowing full customization:</span>
<span class="sd">            * ``soft_f1_loss()`` ‚Äî explicit soft-F1 loss</span>
<span class="sd">            * ``focal_loss(alpha=0.25, gamma=2.0)`` ‚Äî focal loss with parameters</span>
<span class="sd">            * Any user-defined loss function of signature ``loss(y_true, y_pred)``</span>

<span class="sd">    epochs_2 : int, optional</span>
<span class="sd">        Number of training epochs during the second phase (focal-loss fine-tuning).</span>
<span class="sd">        Required only when `stage_2=True`.</span>

<span class="sd">    mismatch_share_2 : float, optional</span>
<span class="sd">        Fraction of sampled negative pairs used during Round 2.</span>
<span class="sd">        Required only when `stage_2=True`.</span>

<span class="sd">    gamma : float, optional</span>
<span class="sd">        Focusing parameter of the focal loss (Round 2).  </span>
<span class="sd">        Required only when `stage_2=True`.</span>

<span class="sd">    max_alpha : float, optional</span>
<span class="sd">        Maximum weighting factor of the positive class for focal loss (Round 2).  </span>
<span class="sd">        Required only when `stage_2=True`.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    None</span>

<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    - The pipeline assumes that the data have already been preprocessed, formatted, and tokenized.</span>
<span class="sd">    - Round 1 (soft-F1 phase) initializes the model and emphasizes balanced learning across classes.</span>
<span class="sd">    - Round 2 (focal-loss phase) refines the model to focus on hard-to-classify examples.</span>
<span class="sd">    - Dynamic heuristics are used to automatically infer:</span>
<span class="sd">        * Batch size (via expected positive density)</span>
<span class="sd">        * Peak learning rate (scaled with batch size, positives per batch, and parameter count)</span>
<span class="sd">        * Weight decay (adjusted based on model size and learning rate)</span>
<span class="sd">    - Model checkpoints, histories, and evaluation reports are stored in subdirectories named</span>
<span class="sd">      after the provided `model_name`.</span>
<span class="sd">    - The final model, similarity map, and performance metrics are exported to disk using the</span>
<span class="sd">      `Training.performance_statistics_export` method for reproducibility.</span>
<span class="sd">    - Each training stage can be enabled or disabled independently through</span>
<span class="sd">    the `stage_1` and `stage_2` flags.</span>
<span class="sd">    - If a stage is disabled, its hyperparameters are not required and will</span>
<span class="sd">    be ignored.</span>
<span class="sd">    - When only one stage is active, the warm-up pass automatically adapts</span>
<span class="sd">    to the active stage&#39;s mismatch sampling configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ---------- Built-in helpers ----------</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">required_batch_size</span><span class="p">(</span><span class="n">num_matches</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                            <span class="n">num_left</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                            <span class="n">num_right</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                            <span class="n">mismatch_share</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                            <span class="n">desired_pos_per_batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
                            <span class="n">eps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-12</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="n">total_mismatches</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">num_left</span> <span class="o">*</span> <span class="n">num_right</span> <span class="o">-</span> <span class="n">num_matches</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">sampled_negatives</span> <span class="o">=</span> <span class="n">mismatch_share</span> <span class="o">*</span> <span class="n">total_mismatches</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="n">num_matches</span> <span class="o">+</span> <span class="n">sampled_negatives</span>
        <span class="k">if</span> <span class="n">denom</span> <span class="o">&lt;=</span> <span class="n">eps</span> <span class="ow">or</span> <span class="n">num_matches</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">desired_pos_per_batch</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">0.0</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">num_matches</span> <span class="o">/</span> <span class="n">denom</span>
        <span class="n">q</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">eps</span><span class="p">)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">desired_pos_per_batch</span> <span class="o">/</span> <span class="n">q</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">*</span> <span class="n">q</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">count_trainable_params</span><span class="p">(</span><span class="n">keras_model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">num_elements</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">keras_model</span><span class="o">.</span><span class="n">trainable_variables</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">suggest_peak_lr_adamw</span><span class="p">(</span><span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                              <span class="n">positives_per_batch</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">param_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">base_batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
                              <span class="n">base_lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span>
                              <span class="n">min_lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3e-4</span><span class="p">,</span>
                              <span class="n">max_lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3e-3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="n">base_lr</span> <span class="o">*</span> <span class="p">(</span><span class="n">batch_size</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">base_batch</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">positives_per_batch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">positives_per_batch</span><span class="p">,</span> <span class="mf">16.0</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">shrink</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">+</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">15.0</span><span class="p">)</span>  <span class="c1"># in [0.6, 1.0]</span>
            <span class="n">lr</span> <span class="o">*=</span> <span class="n">shrink</span>
        <span class="k">if</span> <span class="n">param_count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">param_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">10_000_000</span><span class="p">)</span>
            <span class="n">lr</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">0.8</span> <span class="o">**</span> <span class="nb">max</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">max_lr</span><span class="p">),</span> <span class="n">min_lr</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_suggest_weight_decay_adamw</span><span class="p">(</span><span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                    <span class="n">param_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                    <span class="n">base_batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
                                    <span class="n">base_params</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10_000_000</span><span class="p">,</span>
                                    <span class="n">base_lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span>
                                    <span class="n">base_wd</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5e-4</span><span class="p">,</span>
                                    <span class="n">wd_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">,</span>
                                    <span class="n">wd_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5e-3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">batch_scale</span> <span class="o">=</span> <span class="n">base_batch</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
        <span class="n">batch_scale</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">batch_scale</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="n">param_scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_params</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">param_count</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.2</span>
        <span class="n">param_scale</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">param_scale</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="n">lr_scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">learning_rate</span> <span class="o">/</span> <span class="n">base_lr</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="n">lr_scale</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">lr_scale</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="n">wd</span> <span class="o">=</span> <span class="n">base_wd</span> <span class="o">*</span> <span class="n">batch_scale</span> <span class="o">*</span> <span class="n">param_scale</span> <span class="o">*</span> <span class="n">lr_scale</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">wd</span><span class="p">,</span> <span class="n">wd_max</span><span class="p">),</span> <span class="n">wd_min</span><span class="p">))</span>

    <span class="c1"># ---------- Inner: WarmupCosine schedule ----------</span>
<div class="viewcode-block" id="TrainingPipe.WarmupCosine">
<a class="viewcode-back" href="../../training.html#neer_match_utilities.training.TrainingPipe.WarmupCosine">[docs]</a>
    <span class="nd">@tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">register_keras_serializable</span><span class="p">(</span><span class="n">package</span><span class="o">=</span><span class="s2">&quot;custom&quot;</span><span class="p">)</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">WarmupCosine</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">schedules</span><span class="o">.</span><span class="n">LearningRateSchedule</span><span class="p">):</span>
<div class="viewcode-block" id="TrainingPipe.WarmupCosine.__init__">
<a class="viewcode-back" href="../../training.html#neer_match_utilities.training.TrainingPipe.WarmupCosine.__init__">[docs]</a>
        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peak_lr</span><span class="p">,</span> <span class="n">warmup_steps</span><span class="p">,</span> <span class="n">total_steps</span><span class="p">,</span> <span class="n">min_lr_ratio</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peak_lr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">peak_lr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warmup_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">warmup_steps</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">total_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_steps</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">min_lr_ratio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">min_lr_ratio</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span></div>


        <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
            <span class="n">step</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">peak</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peak_lr</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">warm_steps</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">warmup_steps</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">tot_steps</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_steps</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">min_ratio</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_lr_ratio</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="n">warm</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">*</span> <span class="p">(</span><span class="n">step</span> <span class="o">/</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">warm_steps</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
            <span class="n">cos</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">min_ratio</span>
                <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">min_ratio</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">step</span> <span class="o">-</span> <span class="n">warm_steps</span><span class="p">)</span> <span class="o">/</span>
                                <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">tot_steps</span> <span class="o">-</span> <span class="n">warm_steps</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)))</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">step</span> <span class="o">&lt;</span> <span class="n">warm_steps</span><span class="p">,</span> <span class="n">warm</span><span class="p">,</span> <span class="n">cos</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;peak_lr&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_lr</span><span class="p">,</span>
                <span class="s2">&quot;warmup_steps&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warmup_steps</span><span class="p">,</span>
                <span class="s2">&quot;total_steps&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_steps</span><span class="p">,</span>
                <span class="s2">&quot;min_lr_ratio&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_lr_ratio</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">}</span>

<div class="viewcode-block" id="TrainingPipe.WarmupCosine.from_config">
<a class="viewcode-back" href="../../training.html#neer_match_utilities.training.TrainingPipe.WarmupCosine.from_config">[docs]</a>
        <span class="nd">@classmethod</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span></div>
</div>


    <span class="c1"># ---------- Pipeline ----------</span>
<div class="viewcode-block" id="TrainingPipe.__init__">
<a class="viewcode-back" href="../../training.html#neer_match_utilities.training.TrainingPipe.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">training_data</span><span class="p">,</span>   <span class="c1"># (left_train, right_train, matches_train) OR dict with keys</span>
        <span class="n">testing_data</span><span class="p">,</span>    <span class="c1"># (left_test, right_test, matches_test)   OR dict with keys</span>
        <span class="n">similarity_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">initial_feature_width_scales</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">feature_depths</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">initial_record_width_scale</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">record_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">id_left_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;id_unique&quot;</span><span class="p">,</span>
        <span class="n">id_right_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;id_unique&quot;</span><span class="p">,</span>
        <span class="n">no_tm_pbatch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_architecture</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">stage_1</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">stage_2</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">epochs_1</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mismatch_share_1</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stage1_loss</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">callable</span> <span class="o">=</span> <span class="n">soft_f1_loss</span><span class="p">(),</span>
        <span class="n">epochs_2</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mismatch_share_2</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">similarity_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;similarity_map is required and must not be None.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">similarity_map</span> <span class="o">=</span> <span class="n">similarity_map</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_feature_width_scales</span> <span class="o">=</span> <span class="n">initial_feature_width_scales</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_depths</span> <span class="o">=</span> <span class="n">feature_depths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_record_width_scale</span> <span class="o">=</span> <span class="n">initial_record_width_scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">record_depth</span> <span class="o">=</span> <span class="n">record_depth</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stage_1</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">stage_1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage_2</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">stage_2</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;At least one of stage_1 or stage_2 must be True.&quot;</span><span class="p">)</span>

        <span class="c1"># ---- Stage 1 hyperparameters ----</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_1</span><span class="p">:</span>
            <span class="n">missing_stage1</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">name</span><span class="p">:</span> <span class="n">val</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s2">&quot;epochs_1&quot;</span><span class="p">,</span> <span class="n">epochs_1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;mismatch_share_1&quot;</span><span class="p">,</span> <span class="n">mismatch_share_1</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;no_tm_pbatch&quot;</span><span class="p">,</span> <span class="n">no_tm_pbatch</span><span class="p">),</span>  <span class="c1"># NEW</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">missing_stage1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The following arguments must be provided when stage_1=True: &quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_stage1</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">epochs_1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">epochs_1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mismatch_share_1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mismatch_share_1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_tm_pbatch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">no_tm_pbatch</span><span class="p">)</span>

        <span class="c1"># ---- Stage 1 loss configuration ----</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">stage1_loss</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">callable</span><span class="p">(</span><span class="n">stage1_loss</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;stage1_loss must be a loss name (str) or a callable.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage1_loss</span> <span class="o">=</span> <span class="n">stage1_loss</span>

        <span class="c1"># ---- Stage 2 hyperparameters ----</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_2</span><span class="p">:</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">name</span><span class="p">:</span> <span class="n">val</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s2">&quot;epochs_2&quot;</span><span class="p">,</span> <span class="n">epochs_2</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;mismatch_share_2&quot;</span><span class="p">,</span> <span class="n">mismatch_share_2</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;no_tm_pbatch&quot;</span><span class="p">,</span> <span class="n">no_tm_pbatch</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;gamma&quot;</span><span class="p">,</span> <span class="n">gamma</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;max_alpha&quot;</span><span class="p">,</span> <span class="n">max_alpha</span><span class="p">),</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="n">missing_keys</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The following arguments must be provided when stage_2=True: </span><span class="si">{</span><span class="n">missing_keys</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">epochs_2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">epochs_2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mismatch_share_2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mismatch_share_2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_tm_pbatch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">no_tm_pbatch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_alpha</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_alpha</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># dummy values; not used when stage_2=False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epochs_2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mismatch_share_2</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_tm_pbatch</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_alpha</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id_left_col</span> <span class="o">=</span> <span class="n">id_left_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_right_col</span> <span class="o">=</span> <span class="n">id_right_col</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_architecture</span> <span class="o">=</span> <span class="n">save_architecture</span>

        <span class="c1"># Unpack user-supplied data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_split</span><span class="p">(</span><span class="n">training_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_split</span><span class="p">(</span><span class="n">testing_data</span><span class="p">)</span>

        <span class="c1"># Basic sanity checks</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;left_train&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">left_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_left_col</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;right_train&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_right_col</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;left_test&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">left_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_left_col</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;right_test&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_right_col</span><span class="p">),</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> must include column &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">DLMatchingModel</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Minimal Training helper for exporting stats at the end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_util</span> <span class="o">=</span> <span class="n">Training</span><span class="p">(</span>
            <span class="n">similarity_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">similarity_map</span><span class="p">,</span>
            <span class="n">df_left</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">left_train</span><span class="p">,</span>
            <span class="n">df_right</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">right_train</span><span class="p">,</span>
            <span class="n">id_left</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_left_col</span><span class="p">,</span>
            <span class="n">id_right</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_right_col</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_unpack_split</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;matches&quot;</span><span class="p">]</span>
        <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">matches</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="k">return</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">matches</span>

    <span class="c1"># ---------- Public entry point ----------</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Build model with provided similarity map</span>
        <span class="n">smap</span> <span class="o">=</span> <span class="n">SimilarityMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">similarity_map</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">DLMatchingModel</span><span class="p">(</span>
            <span class="n">similarity_map</span><span class="o">=</span><span class="n">smap</span><span class="p">,</span> 
            <span class="n">initial_feature_width_scales</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_feature_width_scales</span><span class="p">,</span>
            <span class="n">feature_depths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_depths</span><span class="p">,</span>
            <span class="n">initial_record_width_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_record_width_scale</span><span class="p">,</span>
            <span class="n">record_depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_depth</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Warmup pass to initialize shapes/BN, etc.</span>
        <span class="c1"># Use mismatch_share_1 if stage_1 is active, otherwise fall back to stage_2.</span>
        <span class="n">warmup_mismatch_share</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mismatch_share_1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">mismatch_share_2</span>
        <span class="p">)</span>

        <span class="n">bsz_warm</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_batch_size</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matches_train</span><span class="p">),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left_train</span><span class="p">),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">right_train</span><span class="p">),</span>
            <span class="n">warmup_mismatch_share</span><span class="p">,</span>
            <span class="n">desired_pos_per_batch</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">left_train</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">right_train</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">matches_train</span><span class="p">,</span>
            <span class="n">epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">bsz_warm</span><span class="p">,</span>
            <span class="n">mismatch_share</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Count params</span>
        <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_trainable_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>

        <span class="c1"># Round 1 (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_round1</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

        <span class="c1"># Round 2 (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_round2</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

        <span class="c1"># Save, evaluate, export</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_and_report</span><span class="p">()</span>

    <span class="c1"># ---------- Rounds ----------</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_round1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="n">batch_size</span><span class="p">,</span> <span class="n">expected_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_batch_size</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matches_train</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left_train</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">right_train</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mismatch_share_1</span><span class="p">,</span> <span class="n">desired_pos_per_batch</span><span class="o">=</span><span class="mi">16</span>
        <span class="p">)</span>
        <span class="n">peak_lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suggest_peak_lr_adamw</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">expected_pos</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>

        <span class="n">no_obs_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mismatch_share_1</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left_train</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">right_train</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matches_train</span><span class="p">))</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matches_train</span><span class="p">)</span>
        <span class="n">steps_per_epoch_1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">no_obs_1</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">total_steps_1</span> <span class="o">=</span> <span class="n">steps_per_epoch_1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs_1</span>
        <span class="n">warmup_steps_1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">total_steps_1</span><span class="p">)</span>

        <span class="n">lr_sched_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">WarmupCosine</span><span class="p">(</span><span class="n">peak_lr</span><span class="p">,</span> <span class="n">warmup_steps_1</span><span class="p">,</span> <span class="n">total_steps_1</span><span class="p">,</span> <span class="n">min_lr_ratio</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="n">wd_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_suggest_weight_decay_adamw</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">peak_lr</span><span class="p">)</span>
        <span class="n">opt_1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">lr_sched_1</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">wd_1</span><span class="p">,</span> <span class="n">clipnorm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="n">loss_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stage1_loss</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">loss_1</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">opt_1</span><span class="p">)</span>

        <span class="n">saver</span> <span class="o">=</span> <span class="n">EpochEndSaver</span><span class="p">(</span><span class="n">base_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">)</span>
        <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">left_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_train</span><span class="p">,</span>
            <span class="n">epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs_1</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">mismatch_share</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mismatch_share_1</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">saver</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">df_epoch</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
        <span class="n">df_epoch</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">/</span> <span class="s2">&quot;checkpoints&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df_epoch</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">/</span> <span class="s2">&quot;checkpoints&quot;</span> <span class="o">/</span> <span class="s2">&quot;epoch_overview.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">best_row</span> <span class="o">=</span> <span class="n">df_epoch</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_epoch</span><span class="p">[</span><span class="s2">&quot;f1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()]</span>
        <span class="n">best_epoch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">best_row</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">])</span>
        <span class="n">best_epoch_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">best_epoch</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Load best R1 model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">/</span> <span class="s2">&quot;checkpoints&quot;</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;epoch_</span><span class="si">{</span><span class="n">best_epoch_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[R1] best epoch:&quot;</span><span class="p">,</span> <span class="n">best_epoch</span><span class="p">,</span> <span class="s2">&quot;path:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">/</span> <span class="s2">&quot;checkpoints_round1&quot;</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;epoch_</span><span class="si">{</span><span class="n">best_epoch_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Sanity-evaluate the loaded model before Round 2 training</span>
        <span class="n">probe_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stage1_loss</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">probe_loss</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">())</span>  <span class="c1"># dummy opt</span>
        <span class="n">eval_probe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">left_train</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">right_train</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">matches_train</span><span class="p">,</span>
            <span class="n">mismatch_share</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mismatch_share_1</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[R1-&gt;R2] probe metrics after load:&quot;</span><span class="p">,</span> <span class="n">eval_probe</span><span class="p">)</span>

        <span class="c1"># Preserve Round 1 checkpoints</span>
        <span class="n">old_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">/</span> <span class="s2">&quot;checkpoints&quot;</span>
        <span class="n">new_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">/</span> <span class="s2">&quot;checkpoints_stage_1&quot;</span>
        <span class="k">if</span> <span class="n">old_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">old_path</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">new_path</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_stage1_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resolve the configured Stage 1 loss into a *callable* loss function.</span>

<span class="sd">        - If self.stage1_loss is &quot;soft_f1&quot;: return soft_f1_loss()</span>
<span class="sd">        (this preserves the original behavior)</span>
<span class="sd">        - If self.stage1_loss is &quot;binary_crossentropy&quot;: return a wrapped BCE</span>
<span class="sd">        that reshapes labels/preds to be compatible with NeerMatch&#39;s evaluate loop.</span>
<span class="sd">        - If self.stage1_loss is a callable (e.g. soft_f1_loss(), focal_loss(...)):</span>
<span class="sd">        return it as-is.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Case 1: user passed a ready-made callable, e.g. soft_f1_loss() or focal_loss(...)</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage1_loss</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage1_loss</span>

        <span class="c1"># Case 2: string selector</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage1_loss</span> <span class="o">==</span> <span class="s2">&quot;soft_f1&quot;</span><span class="p">:</span>
            <span class="c1"># Default behavior: identical to original code</span>
            <span class="k">return</span> <span class="n">soft_f1_loss</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage1_loss</span> <span class="o">==</span> <span class="s2">&quot;binary_crossentropy&quot;</span><span class="p">:</span>
            <span class="c1"># Wrap BCE to be robust to whatever shapes NeerMatch passes in</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">bce_wrapped</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
                <span class="n">y_true</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">y_pred</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="c1"># Flatten to 1D so shapes always match</span>
                <span class="n">y_true</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,))</span>
                <span class="n">y_pred</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,))</span>
                <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">binary_crossentropy</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">bce_wrapped</span>

        <span class="c1"># You can add more named options here if you like</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown stage1_loss string: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stage1_loss</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_round2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># alpha bounded by your alpha_balanced (expects max_alpha argument in your implementation)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha_balanced</span><span class="p">(</span>
            <span class="n">left</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">left_train</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">right_train</span><span class="p">,</span> <span class="n">matches</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">matches_train</span><span class="p">,</span>
            <span class="n">mismatch_share</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mismatch_share_2</span><span class="p">,</span> <span class="n">max_alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_alpha</span>
        <span class="p">)</span>

        <span class="n">batch_size</span><span class="p">,</span> <span class="n">expected_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_batch_size</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matches_train</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left_train</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">right_train</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mismatch_share_2</span><span class="p">,</span> <span class="n">desired_pos_per_batch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">no_tm_pbatch</span>
        <span class="p">)</span>
        <span class="n">no_obs_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mismatch_share_2</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left_train</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">right_train</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matches_train</span><span class="p">))</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matches_train</span><span class="p">)</span>
        <span class="n">steps_per_epoch_2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">no_obs_2</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">total_steps_2</span> <span class="o">=</span> <span class="n">steps_per_epoch_2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">epochs_2</span>
        <span class="n">warmup_steps_2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">total_steps_2</span><span class="p">)</span>

        <span class="n">peak_lr_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suggest_peak_lr_adamw</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">expected_pos</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
        <span class="n">peak_lr_2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">peak_lr_2</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">)</span>  <span class="c1"># your cap</span>

        <span class="n">lr_sched_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">WarmupCosine</span><span class="p">(</span><span class="n">peak_lr_2</span><span class="p">,</span> <span class="n">warmup_steps_2</span><span class="p">,</span> <span class="n">total_steps_2</span><span class="p">,</span> <span class="n">min_lr_ratio</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">wd_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_suggest_weight_decay_adamw</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">peak_lr_2</span><span class="p">)</span>
        <span class="n">opt_2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="n">lr_sched_2</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">wd_2</span><span class="p">,</span> <span class="n">clipnorm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">focal_loss</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">),</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">opt_2</span><span class="p">)</span>

        <span class="n">saver</span> <span class="o">=</span> <span class="n">EpochEndSaver</span><span class="p">(</span><span class="n">base_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">)</span>
        <span class="n">history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">left_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_train</span><span class="p">,</span>
            <span class="n">epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epochs_2</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">mismatch_share</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mismatch_share_2</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">saver</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">df_epoch</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
        <span class="n">df_epoch</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">/</span> <span class="s2">&quot;checkpoints&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df_epoch</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">/</span> <span class="s2">&quot;checkpoints&quot;</span> <span class="o">/</span> <span class="s2">&quot;epoch_overview.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">best_row</span> <span class="o">=</span> <span class="n">df_epoch</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_epoch</span><span class="p">[</span><span class="s2">&quot;f1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()]</span>
        <span class="n">best_epoch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">best_row</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">])</span>
        <span class="n">best_epoch_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">best_epoch</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">/</span> <span class="s2">&quot;checkpoints&quot;</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;epoch_</span><span class="si">{</span><span class="n">best_epoch_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[R2] best epoch:&quot;</span><span class="p">,</span> <span class="n">best_epoch</span><span class="p">,</span> <span class="s2">&quot;path:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">/</span> <span class="s2">&quot;checkpoints&quot;</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;epoch_</span><span class="si">{</span><span class="n">best_epoch_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Re-compile for export/eval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">focal_loss</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">),</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">opt_2</span><span class="p">)</span>

        <span class="c1"># Re-name checkpoints folder</span>
        <span class="n">old_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">/</span> <span class="s2">&quot;checkpoints&quot;</span>
        <span class="n">new_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">/</span> <span class="s2">&quot;checkpoints_stage_2&quot;</span>
        <span class="k">if</span> <span class="n">old_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">new_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">new_path</span><span class="p">)</span>  <span class="c1"># optional: only needed if rerunning</span>
            <span class="n">old_path</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">new_path</span><span class="p">)</span>

    <span class="c1"># ---------- Save / evaluate ----------</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_finalize_and_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_util</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># Save the final bundle</span>
        <span class="n">Model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">target_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="n">save_architecture</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">save_architecture</span><span class="p">)</span>

        <span class="c1"># Evaluate on supplied splits</span>
        <span class="n">perf_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_train</span><span class="p">,</span> <span class="n">mismatch_share</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">perf_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">left_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_test</span><span class="p">,</span> <span class="n">mismatch_share</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># Export stats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_util</span><span class="o">.</span><span class="n">performance_statistics_export</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="n">target_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="p">,</span>
            <span class="n">evaluation_train</span><span class="o">=</span><span class="n">perf_train</span><span class="p">,</span> <span class="n">evaluation_test</span><span class="o">=</span><span class="n">perf_test</span>
        <span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Pantelis Karapanagiotis, Marius Liebald.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>