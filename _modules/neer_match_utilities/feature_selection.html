

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>neer_match_utilities.feature_selection &mdash; Neer Match Utilities 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/extra.css?v=503a7970" />
      <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.min.css" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
      <script src="https://cdn.datatables.net/2.1.8/js/dataTables.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Neer Match Utilities
              <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../install.html#pipy">PiPy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../install.html#from-source">From Source</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../basic_training_pipeline.html">A Minimal Training Pipeline</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../basic_training_pipeline.html#loading-the-data">Loading the Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../basic_training_pipeline.html#defining-features-and-similarity-concepts">Defining Features and Similarity Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../basic_training_pipeline.html#harmonizing-the-data">Harmonizing the data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../basic_training_pipeline.html#left-and-right">Left and Right</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../basic_training_pipeline.html#re-structuring-the-matches-dataframe">Re-Structuring the <code class="docutils literal notranslate"><span class="pre">Matches</span></code> dataframe</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../basic_training_pipeline.html#splitting-data">Splitting Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../basic_training_pipeline.html#training-and-exporting-the-model">Training and Exporting the Model</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../id_generation.html">Creating a Common Identifier (ID)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../id_generation.html#between-two-sources">Between Two Sources</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../id_generation.html#load-data-model">1. Load Data &amp; Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../id_generation.html#harmonize-format">2. Harmonize Format</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../id_generation.html#generate-a-common-id">3. Generate a Common ID</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../id_generation.html#merge-results">4. Merge Results</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../id_generation.html#repeated-cross-sections-panel-id">Repeated Cross-Sections (Panel ID)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../alternative_models.html">Alternative Classification Models</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../alternative_models.html#baseline-models">Baseline Models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../alternative_models.html#logit-model">Logit Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../alternative_models.html#probit-model">Probit Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../alternative_models.html#gradient-boosting-model">Gradient Boosting Model</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../alternative_models.html#deep-learning-model-ann">Deep Learning Model (ANN)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../alternative_models.html#key-parameters-explained">Key Parameters Explained</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../alternative_models.html#single-stage-training">Single-Stage Training</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../alternative_models.html#model-comparison">Model Comparison</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../additional_functionalities.html">Additional Functionalities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../additional_functionalities.html#name-commonness">Name Commonness</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../additional_functionalities.html#stop-word-removal-with-spacy">Stop Word Removal with spaCy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../additional_functionalities.html#feature-selection">Feature Selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../additional_functionalities.html#handling-many-to-many-matches">Handling Many-to-Many Matches</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../additional_functionalities.html#loading-the-data">Loading the Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../additional_functionalities.html#inspecting-the-data">Inspecting the Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../additional_functionalities.html#simulating-a-many-to-many-relationship">Simulating a Many-to-Many Relationship</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../additional_functionalities.html#understanding-the-matching-issue">Understanding the Matching Issue</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../additional_functionalities.html#correcting-the-relationships">Correcting the Relationships</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../additional_functionalities.html#verifying-the-adjustments">6. Verifying the Adjustments</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../base.html">Base</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model.html">Model</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../model.html#neer_match_utilities.model.EpochEndSaver"><code class="docutils literal notranslate"><span class="pre">EpochEndSaver</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../model.html#neer_match_utilities.model.EpochEndSaver.__init__"><code class="docutils literal notranslate"><span class="pre">EpochEndSaver.__init__()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../model.html#neer_match_utilities.model.EpochEndSaver.on_epoch_end"><code class="docutils literal notranslate"><span class="pre">EpochEndSaver.on_epoch_end()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../model.html#neer_match_utilities.model.Model"><code class="docutils literal notranslate"><span class="pre">Model</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../model.html#neer_match_utilities.model.Model.load"><code class="docutils literal notranslate"><span class="pre">Model.load()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../model.html#neer_match_utilities.model.Model.save"><code class="docutils literal notranslate"><span class="pre">Model.save()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../baseline_models.html">Baseline Models</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../baseline_models.html#neer_match_utilities.baseline_models.GradientBoostingModel"><code class="docutils literal notranslate"><span class="pre">GradientBoostingModel</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../baseline_models.html#neer_match_utilities.baseline_models.GradientBoostingModel.__init__"><code class="docutils literal notranslate"><span class="pre">GradientBoostingModel.__init__()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../baseline_models.html#neer_match_utilities.baseline_models.GradientBoostingModel.best_threshold"><code class="docutils literal notranslate"><span class="pre">GradientBoostingModel.best_threshold()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../baseline_models.html#neer_match_utilities.baseline_models.GradientBoostingModel.evaluate"><code class="docutils literal notranslate"><span class="pre">GradientBoostingModel.evaluate()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../baseline_models.html#neer_match_utilities.baseline_models.GradientBoostingModel.fit"><code class="docutils literal notranslate"><span class="pre">GradientBoostingModel.fit()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../baseline_models.html#neer_match_utilities.baseline_models.GradientBoostingModel.predict_proba"><code class="docutils literal notranslate"><span class="pre">GradientBoostingModel.predict_proba()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../baseline_models.html#neer_match_utilities.baseline_models.GradientBoostingModel.summary"><code class="docutils literal notranslate"><span class="pre">GradientBoostingModel.summary()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../baseline_models.html#neer_match_utilities.baseline_models.LogitMatchingModel"><code class="docutils literal notranslate"><span class="pre">LogitMatchingModel</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../baseline_models.html#neer_match_utilities.baseline_models.LogitMatchingModel.__init__"><code class="docutils literal notranslate"><span class="pre">LogitMatchingModel.__init__()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../baseline_models.html#neer_match_utilities.baseline_models.LogitMatchingModel.fit"><code class="docutils literal notranslate"><span class="pre">LogitMatchingModel.fit()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../baseline_models.html#neer_match_utilities.baseline_models.ProbitMatchingModel"><code class="docutils literal notranslate"><span class="pre">ProbitMatchingModel</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../baseline_models.html#neer_match_utilities.baseline_models.ProbitMatchingModel.__init__"><code class="docutils literal notranslate"><span class="pre">ProbitMatchingModel.__init__()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../baseline_models.html#neer_match_utilities.baseline_models.ProbitMatchingModel.fit"><code class="docutils literal notranslate"><span class="pre">ProbitMatchingModel.fit()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../baseline_models.html#neer_match_utilities.baseline_models.SuggestMixin"><code class="docutils literal notranslate"><span class="pre">SuggestMixin</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../baseline_models.html#neer_match_utilities.baseline_models.SuggestMixin.suggest"><code class="docutils literal notranslate"><span class="pre">SuggestMixin.suggest()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../baseline_training.html">Baseline Training</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../baseline_training.html#neer_match_utilities.baseline_training.BaselineTrainingPipe"><code class="docutils literal notranslate"><span class="pre">BaselineTrainingPipe</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../baseline_training.html#neer_match_utilities.baseline_training.BaselineTrainingPipe.__init__"><code class="docutils literal notranslate"><span class="pre">BaselineTrainingPipe.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../baseline_io.html">Baseline IO</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../baseline_io.html#neer_match_utilities.baseline_io.ModelBaseline"><code class="docutils literal notranslate"><span class="pre">ModelBaseline</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../baseline_io.html#neer_match_utilities.baseline_io.ModelBaseline.save"><code class="docutils literal notranslate"><span class="pre">ModelBaseline.save()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../panel.html">Panel</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.GenerateID"><code class="docutils literal notranslate"><span class="pre">GenerateID</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.GenerateID.__init__"><code class="docutils literal notranslate"><span class="pre">GenerateID.__init__()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.GenerateID.assign_ids"><code class="docutils literal notranslate"><span class="pre">GenerateID.assign_ids()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.GenerateID.execute"><code class="docutils literal notranslate"><span class="pre">GenerateID.execute()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.GenerateID.generate_suggestions"><code class="docutils literal notranslate"><span class="pre">GenerateID.generate_suggestions()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.GenerateID.group_by_subgroups"><code class="docutils literal notranslate"><span class="pre">GenerateID.group_by_subgroups()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.GenerateID.harmonize_ids"><code class="docutils literal notranslate"><span class="pre">GenerateID.harmonize_ids()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.GenerateID.relations_left_right"><code class="docutils literal notranslate"><span class="pre">GenerateID.relations_left_right()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.SetupData"><code class="docutils literal notranslate"><span class="pre">SetupData</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.SetupData.matches"><code class="docutils literal notranslate"><span class="pre">SetupData.matches</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.SetupData.__init__"><code class="docutils literal notranslate"><span class="pre">SetupData.__init__()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.SetupData.adjust_overlap"><code class="docutils literal notranslate"><span class="pre">SetupData.adjust_overlap()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.SetupData.create_connected_groups"><code class="docutils literal notranslate"><span class="pre">SetupData.create_connected_groups()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.SetupData.data_preparation_panel"><code class="docutils literal notranslate"><span class="pre">SetupData.data_preparation_panel()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.SetupData.drop_repetitions"><code class="docutils literal notranslate"><span class="pre">SetupData.drop_repetitions()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../panel.html#neer_match_utilities.panel.SetupData.panel_preparation"><code class="docutils literal notranslate"><span class="pre">SetupData.panel_preparation()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../prepare.html">Prepare</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../prepare.html#neer_match_utilities.prepare.Prepare"><code class="docutils literal notranslate"><span class="pre">Prepare</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../prepare.html#neer_match_utilities.prepare.Prepare.__init__"><code class="docutils literal notranslate"><span class="pre">Prepare.__init__()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../prepare.html#neer_match_utilities.prepare.Prepare.do_remove_stop_words"><code class="docutils literal notranslate"><span class="pre">Prepare.do_remove_stop_words()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../prepare.html#neer_match_utilities.prepare.Prepare.format"><code class="docutils literal notranslate"><span class="pre">Prepare.format()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../prepare.html#neer_match_utilities.prepare.similarity_map_to_dict"><code class="docutils literal notranslate"><span class="pre">similarity_map_to_dict()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../prepare.html#neer_match_utilities.prepare.synth_mismatches"><code class="docutils literal notranslate"><span class="pre">synth_mismatches()</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../split.html">Split</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../split.html#neer_match_utilities.split.SplitError"><code class="docutils literal notranslate"><span class="pre">SplitError</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../split.html#neer_match_utilities.split.split_test_train"><code class="docutils literal notranslate"><span class="pre">split_test_train()</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../training.html">Training</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../training.html#neer_match_utilities.training.Training"><code class="docutils literal notranslate"><span class="pre">Training</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../training.html#neer_match_utilities.training.Training.evaluate_dataframe"><code class="docutils literal notranslate"><span class="pre">Training.evaluate_dataframe()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../training.html#neer_match_utilities.training.Training.matches_reorder"><code class="docutils literal notranslate"><span class="pre">Training.matches_reorder()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../training.html#neer_match_utilities.training.Training.performance_statistics_export"><code class="docutils literal notranslate"><span class="pre">Training.performance_statistics_export()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../training.html#neer_match_utilities.training.TrainingPipe"><code class="docutils literal notranslate"><span class="pre">TrainingPipe</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../training.html#neer_match_utilities.training.TrainingPipe.WarmupCosine"><code class="docutils literal notranslate"><span class="pre">TrainingPipe.WarmupCosine</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../training.html#neer_match_utilities.training.TrainingPipe.WarmupCosine.__init__"><code class="docutils literal notranslate"><span class="pre">TrainingPipe.WarmupCosine.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../training.html#neer_match_utilities.training.TrainingPipe.WarmupCosine.from_config"><code class="docutils literal notranslate"><span class="pre">TrainingPipe.WarmupCosine.from_config()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../training.html#neer_match_utilities.training.TrainingPipe.__init__"><code class="docutils literal notranslate"><span class="pre">TrainingPipe.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../training.html#neer_match_utilities.training.alpha_balanced"><code class="docutils literal notranslate"><span class="pre">alpha_balanced()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../training.html#neer_match_utilities.training.combined_loss"><code class="docutils literal notranslate"><span class="pre">combined_loss()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../training.html#neer_match_utilities.training.focal_loss"><code class="docutils literal notranslate"><span class="pre">focal_loss()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../training.html#neer_match_utilities.training.soft_f1_loss"><code class="docutils literal notranslate"><span class="pre">soft_f1_loss()</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../feature_selection.html">Feature Selection</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../feature_selection.html#neer_match_utilities.feature_selection.FeatureSelectionResult"><code class="docutils literal notranslate"><span class="pre">FeatureSelectionResult</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../feature_selection.html#neer_match_utilities.feature_selection.FeatureSelectionResult.updated_similarity_map"><code class="docutils literal notranslate"><span class="pre">FeatureSelectionResult.updated_similarity_map</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../feature_selection.html#neer_match_utilities.feature_selection.FeatureSelectionResult.selected_feature_columns"><code class="docutils literal notranslate"><span class="pre">FeatureSelectionResult.selected_feature_columns</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../feature_selection.html#neer_match_utilities.feature_selection.FeatureSelectionResult.selected_pairs"><code class="docutils literal notranslate"><span class="pre">FeatureSelectionResult.selected_pairs</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../feature_selection.html#neer_match_utilities.feature_selection.FeatureSelectionResult.coef_by_feature"><code class="docutils literal notranslate"><span class="pre">FeatureSelectionResult.coef_by_feature</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../feature_selection.html#neer_match_utilities.feature_selection.FeatureSelectionResult.meta"><code class="docutils literal notranslate"><span class="pre">FeatureSelectionResult.meta</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../feature_selection.html#neer_match_utilities.feature_selection.FeatureSelectionResult.__init__"><code class="docutils literal notranslate"><span class="pre">FeatureSelectionResult.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../feature_selection.html#neer_match_utilities.feature_selection.FeatureSelector"><code class="docutils literal notranslate"><span class="pre">FeatureSelector</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../feature_selection.html#neer_match_utilities.feature_selection.FeatureSelector.similarity_map"><code class="docutils literal notranslate"><span class="pre">FeatureSelector.similarity_map</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../feature_selection.html#neer_match_utilities.feature_selection.FeatureSelector.__init__"><code class="docutils literal notranslate"><span class="pre">FeatureSelector.__init__()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../feature_selection.html#neer_match_utilities.feature_selection.FeatureSelector.execute"><code class="docutils literal notranslate"><span class="pre">FeatureSelector.execute()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../feature_selection.html#neer_match_utilities.feature_selection.tqdm_joblib"><code class="docutils literal notranslate"><span class="pre">tqdm_joblib()</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../similarity_features.html">Similarity Features</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../similarity_features.html#neer_match_utilities.similarity_features.SimilarityFeatures"><code class="docutils literal notranslate"><span class="pre">SimilarityFeatures</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../similarity_features.html#neer_match_utilities.similarity_features.SimilarityFeatures.__init__"><code class="docutils literal notranslate"><span class="pre">SimilarityFeatures.__init__()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../similarity_features.html#neer_match_utilities.similarity_features.SimilarityFeatures.pairwise_similarity_dataframe"><code class="docutils literal notranslate"><span class="pre">SimilarityFeatures.pairwise_similarity_dataframe()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../similarity_features.html#neer_match_utilities.similarity_features.subsample_non_matches"><code class="docutils literal notranslate"><span class="pre">subsample_non_matches()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../similarity_features.html#neer_match_utilities.similarity_features.to_X_y"><code class="docutils literal notranslate"><span class="pre">to_X_y()</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../custom_similarities.html">Custom Similarities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../custom_similarities.html#neer_match_utilities.custom_similarities.CustomSimilarities"><code class="docutils literal notranslate"><span class="pre">CustomSimilarities</span></code></a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../custom_similarities.html#neer_match_utilities.custom_similarities.CustomSimilarities.__init__"><code class="docutils literal notranslate"><span class="pre">CustomSimilarities.__init__()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../custom_similarities.html#neer_match_utilities.custom_similarities.CustomSimilarities.notmissing"><code class="docutils literal notranslate"><span class="pre">CustomSimilarities.notmissing()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../custom_similarities.html#neer_match_utilities.custom_similarities.CustomSimilarities.notzero"><code class="docutils literal notranslate"><span class="pre">CustomSimilarities.notzero()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">License</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../LICENSE.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Neer Match Utilities</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">neer_match_utilities.feature_selection</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for neer_match_utilities.feature_selection</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Feature selection utilities for similarity-based entity matching.</span>

<span class="sd">This module provides tools for selecting the most informative similarity features</span>
<span class="sd">from a potentially large set of candidates. It implements a two-stage feature</span>
<span class="sd">selection process:</span>

<span class="sd">1. **Correlation-based filtering**: Removes highly correlated features, keeping</span>
<span class="sd">   the one most correlated with the target variable.</span>
<span class="sd">2. **Elastic net regularization**: Uses penalized logistic regression to identify</span>
<span class="sd">   features that contribute unique predictive information.</span>

<span class="sd">The feature selector is designed to handle extreme class imbalance, which is</span>
<span class="sd">common in entity matching tasks where true matches are rare.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Iterable</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_scorer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">joblib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConvergenceWarning</span>

<span class="c1"># Suppress sklearn warnings about deprecated parameters and convergence issues</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
    <span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">,</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;.*&#39;penalty&#39; was deprecated.*&quot;</span>
<span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">ConvergenceWarning</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.auto</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">tqdm</span> <span class="o">=</span> <span class="kc">None</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">neer_match_utilities.similarity_features</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimilarityFeatures</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">neer_match.similarity_map</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimilarityMap</span>


<span class="n">SimilarityMapDict</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">joblib</span>

<div class="viewcode-block" id="tqdm_joblib">
<a class="viewcode-back" href="../../feature_selection.html#neer_match_utilities.feature_selection.tqdm_joblib">[docs]</a>
<span class="nd">@contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">tqdm_joblib</span><span class="p">(</span><span class="n">tqdm_object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Context manager to integrate tqdm progress bars with joblib parallel execution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tqdm_object : tqdm.tqdm or None</span>
<span class="sd">        Progress bar object to update during parallel execution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tqdm_object</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">yield</span>
        <span class="k">return</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">TqdmBatchCompletionCallback</span><span class="p">(</span><span class="n">joblib</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">BatchCompletionCallBack</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">tqdm_object</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">old_callback</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">BatchCompletionCallBack</span>
    <span class="n">joblib</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">BatchCompletionCallBack</span> <span class="o">=</span> <span class="n">TqdmBatchCompletionCallback</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">joblib</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">BatchCompletionCallBack</span> <span class="o">=</span> <span class="n">old_callback</span>
        <span class="n">tqdm_object</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="FeatureSelectionResult">
<a class="viewcode-back" href="../../feature_selection.html#neer_match_utilities.feature_selection.FeatureSelectionResult">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FeatureSelectionResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Result object returned by FeatureSelector.execute().</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    updated_similarity_map : Dict[str, List[str]]</span>
<span class="sd">        Reduced similarity map containing only selected features.</span>
<span class="sd">        Keys are variable names, values are lists of similarity concept names.</span>
<span class="sd">    selected_feature_columns : List[str]</span>
<span class="sd">        Names of selected feature columns in the format &#39;col_{var}_{var}_{similarity}&#39;.</span>
<span class="sd">    selected_pairs : List[Tuple[str, str]]</span>
<span class="sd">        List of (variable, similarity_concept) tuples that were selected.</span>
<span class="sd">    coef_by_feature : pd.Series</span>
<span class="sd">        Coefficients from the final elastic net model, sorted by absolute value.</span>
<span class="sd">        Useful for understanding feature importance.</span>
<span class="sd">    meta : Dict[str, Any]</span>
<span class="sd">        Metadata about the selection process, including:</span>
<span class="sd">        - method: Feature selection method used</span>
<span class="sd">        - scoring: Scoring metric used for cross-validation</span>
<span class="sd">        - cv: Number of cross-validation folds</span>
<span class="sd">        - n_features_in: Number of input features</span>
<span class="sd">        - n_features_selected: Number of features selected</span>
<span class="sd">        - did_fallback: Whether fallback to original map occurred</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">updated_similarity_map</span><span class="p">:</span> <span class="n">SimilarityMapDict</span>
    <span class="n">selected_feature_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">selected_pairs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span>
    <span class="n">coef_by_feature</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span>
    <span class="n">meta</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span></div>



<div class="viewcode-block" id="FeatureSelector">
<a class="viewcode-back" href="../../feature_selection.html#neer_match_utilities.feature_selection.FeatureSelector">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FeatureSelector</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Supervised feature selector for similarity-based entity matching.</span>

<span class="sd">    This class implements a two-stage feature selection process optimized for</span>
<span class="sd">    entity matching tasks with extreme class imbalance:</span>

<span class="sd">    **Stage 1: Correlation-based filtering** (optional)</span>
<span class="sd">        Removes redundant features by identifying groups of highly correlated</span>
<span class="sd">        features and keeping only the one most correlated with the target.</span>

<span class="sd">    **Stage 2: Elastic net regularization**</span>
<span class="sd">        Uses penalized logistic regression with L1/L2 penalties to identify</span>
<span class="sd">        features that contribute unique predictive information. Cross-validation</span>
<span class="sd">        is used to select optimal regularization parameters.</span>

<span class="sd">    The selector returns an updated similarity map containing only the features</span>
<span class="sd">    that passed both selection stages.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    similarity_map : Dict[str, List[str]] or SimilarityMap</span>
<span class="sd">        Mapping from variable names to lists of similarity concepts.</span>
<span class="sd">        Example: {&#39;name&#39;: [&#39;jaro_winkler&#39;, &#39;levenshtein&#39;], &#39;address&#39;: [&#39;cosine&#39;]}</span>
<span class="sd">    training_data : Tuple[pd.DataFrame, pd.DataFrame, pd.DataFrame]</span>
<span class="sd">        Three-tuple of (left_df, right_df, matches_df) used for feature selection.</span>
<span class="sd">    id_left_col, id_right_col : str, default=&#39;id&#39;</span>
<span class="sd">        Column names containing entity IDs in left and right dataframes.</span>
<span class="sd">    matches_id_left, matches_id_right : str, default=&#39;left&#39;, &#39;right&#39;</span>
<span class="sd">        Column names in matches_df identifying left/right entity IDs.</span>
<span class="sd">    match_col : str, default=&#39;match&#39;</span>
<span class="sd">        Name of the binary match indicator column (1=match, 0=non-match).</span>
<span class="sd">    matches_are_indices : bool, default=True</span>
<span class="sd">        If True, treat match IDs as integer row indices. If False, treat as entity IDs.</span>
<span class="sd">    method : str, default=&#39;elastic_net&#39;</span>
<span class="sd">        Feature selection method. Currently only &#39;elastic_net&#39; is supported.</span>
<span class="sd">    scoring : str, default=&#39;average_precision&#39;</span>
<span class="sd">        Scoring metric for cross-validation. Options: &#39;f1&#39;, &#39;roc_auc&#39;,</span>
<span class="sd">        &#39;average_precision&#39;, &#39;neg_log_loss&#39;. For imbalanced data, &#39;average_precision&#39;</span>
<span class="sd">        is recommended.</span>
<span class="sd">    cv : int, default=5</span>
<span class="sd">        Number of cross-validation folds.</span>
<span class="sd">    l1_ratios : tuple, default=(0.8, 0.9, 1.0)</span>
<span class="sd">        L1 penalty ratios to try. 1.0 = pure Lasso, 0.0 = pure Ridge.</span>
<span class="sd">    Cs : int or Iterable[float], default=20</span>
<span class="sd">        Regularization strengths to try. If int, generates `Cs` values</span>
<span class="sd">        logarithmically spaced from 0.01 to 1000. Higher C = less regularization.</span>
<span class="sd">    class_weight : str or None, default=&#39;balanced&#39;</span>
<span class="sd">        Class weighting strategy. &#39;balanced&#39; adjusts weights inversely proportional</span>
<span class="sd">        to class frequencies, recommended for imbalanced data.</span>
<span class="sd">    max_iter : int, default=5000</span>
<span class="sd">        Maximum iterations for elastic net solver.</span>
<span class="sd">    random_state : int, default=42</span>
<span class="sd">        Random seed for reproducibility.</span>
<span class="sd">    n_jobs : int, default=-1</span>
<span class="sd">        Number of parallel jobs. -1 uses all available processors.</span>
<span class="sd">    min_coef_threshold : float, default=0.0</span>
<span class="sd">        Minimum absolute coefficient value for feature retention. Features with</span>
<span class="sd">        abs(coef) &lt; threshold are dropped. Set to 0.0 to keep all non-zero features.</span>
<span class="sd">    max_correlation : float or None, default=None</span>
<span class="sd">        Correlation threshold for Stage 1 filtering. Features with pairwise</span>
<span class="sd">        correlation &gt; threshold are candidates for removal. Example: 0.95.</span>
<span class="sd">        If None, Stage 1 is skipped.</span>
<span class="sd">    always_keep : Dict[str, List[str]] or None, default=None</span>
<span class="sd">        Features to always retain regardless of selection results.</span>
<span class="sd">        Example: {&#39;surname&#39;: [&#39;jaro_winkler&#39;]} always keeps surname jaro_winkler.</span>
<span class="sd">    preferred_separators : tuple, default=(&#39;__&#39;, &#39;|&#39;, &#39;:&#39;, &#39;-&#39;, &#39;_&#39;)</span>
<span class="sd">        Separators to try when parsing feature names (internal use).</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    similarity_map : Dict[str, List[str]]</span>
<span class="sd">        The input similarity map.</span>
<span class="sd">    left_train, right_train, matches_train : pd.DataFrame</span>
<span class="sd">        Training datasets for feature selection.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from neer_match_utilities import FeatureSelector</span>
<span class="sd">    &gt;&gt;&gt; selector = FeatureSelector(</span>
<span class="sd">    ...     similarity_map={&#39;name&#39;: [&#39;jaro_winkler&#39;, &#39;levenshtein&#39;, &#39;cosine&#39;],</span>
<span class="sd">    ...                     &#39;address&#39;: [&#39;jaro_winkler&#39;, &#39;levenshtein&#39;]},</span>
<span class="sd">    ...     training_data=(left_df, right_df, matches_df),</span>
<span class="sd">    ...     max_correlation=0.95,</span>
<span class="sd">    ...     min_coef_threshold=0.01</span>
<span class="sd">    ... )</span>
<span class="sd">    &gt;&gt;&gt; result = selector.execute()</span>
<span class="sd">    &gt;&gt;&gt; print(result.updated_similarity_map)</span>
<span class="sd">    {&#39;name&#39;: [&#39;jaro_winkler&#39;], &#39;address&#39;: [&#39;levenshtein&#39;]}</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FeatureSelector.__init__">
<a class="viewcode-back" href="../../feature_selection.html#neer_match_utilities.feature_selection.FeatureSelector.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">similarity_map</span><span class="p">:</span> <span class="n">SimilarityMapDict</span><span class="p">,</span>
        <span class="n">training_data</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="c1"># these must match how you build df_train in your pipeline</span>
        <span class="n">id_left_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span>
        <span class="n">id_right_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span>
        <span class="n">matches_id_left</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="n">matches_id_right</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span>
        <span class="n">match_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;match&quot;</span><span class="p">,</span>
        <span class="n">matches_are_indices</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="c1"># selection configuration</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;elastic_net&quot;</span><span class="p">,</span>  <span class="c1"># currently only elastic_net</span>
        <span class="n">scoring</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;average_precision&quot;</span><span class="p">,</span>  <span class="c1"># &quot;f1&quot; | &quot;roc_auc&quot; | &quot;average_precision&quot; | &quot;neg_log_loss&quot;</span>
        <span class="n">cv</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">l1_ratios</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
        <span class="n">Cs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">class_weight</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;balanced&quot;</span><span class="p">,</span>  <span class="c1"># consider &quot;balanced&quot; if match class is rare</span>
        <span class="n">max_iter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
        <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="c1"># thresholding for feature selection</span>
        <span class="n">min_coef_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># drop features with abs(coef) &lt; threshold</span>
        <span class="c1"># correlation-based pre-filtering</span>
        <span class="n">max_correlation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># if set (e.g., 0.95), drop correlated features first</span>
        <span class="c1"># if you want to always keep certain similarities</span>
        <span class="n">always_keep</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="c1"># if feature name parsing fails, you can tell the parser a separator preference</span>
        <span class="n">preferred_separators</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">,</span> <span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">),</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">similarity_map</span><span class="p">:</span> <span class="n">SimilarityMapDict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">similarity_map</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">right_train</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_train</span> <span class="o">=</span> <span class="n">training_data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id_left_col</span> <span class="o">=</span> <span class="n">id_left_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_right_col</span> <span class="o">=</span> <span class="n">id_right_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matches_id_left</span> <span class="o">=</span> <span class="n">matches_id_left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matches_id_right</span> <span class="o">=</span> <span class="n">matches_id_right</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match_col</span> <span class="o">=</span> <span class="n">match_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matches_are_indices</span> <span class="o">=</span> <span class="n">matches_are_indices</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scoring</span> <span class="o">=</span> <span class="n">scoring</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv</span> <span class="o">=</span> <span class="n">cv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l1_ratios</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">l1_ratios</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Cs</span> <span class="o">=</span> <span class="n">Cs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">class_weight</span> <span class="o">=</span> <span class="n">class_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span> <span class="o">=</span> <span class="n">max_iter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span> <span class="o">=</span> <span class="n">random_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span> <span class="o">=</span> <span class="n">n_jobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_coef_threshold</span> <span class="o">=</span> <span class="n">min_coef_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_correlation</span> <span class="o">=</span> <span class="n">max_correlation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">always_keep</span> <span class="o">=</span> <span class="n">always_keep</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preferred_separators</span> <span class="o">=</span> <span class="n">preferred_separators</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_make_Cs_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate grid of regularization parameter values for cross-validation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Array of C values to try during cross-validation.</span>
<span class="sd">            If Cs was specified as an int, returns logarithmically spaced values</span>
<span class="sd">            from 0.01 to 1000. Otherwise returns the provided values.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Higher C values mean less regularization (more features kept).</span>
<span class="sd">        Lower C values mean stronger regularization (more aggressive dropping).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cs</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cs</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_drop_correlated_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove redundant features based on pairwise correlations (Stage 1).</span>

<span class="sd">        For each group of features with pairwise correlation exceeding</span>
<span class="sd">        `self.max_correlation`, this method keeps only the feature most</span>
<span class="sd">        correlated with the target variable and drops the rest.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pd.DataFrame</span>
<span class="sd">            Feature matrix (rows=samples, columns=features).</span>
<span class="sd">        y : np.ndarray</span>
<span class="sd">            Target variable (binary: 0=non-match, 1=match).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            Feature matrix with correlated features removed.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If `self.max_correlation` is None, no filtering is performed and X</span>
<span class="sd">        is returned unchanged.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_correlation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">X</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[FeatureSelector] Checking for correlations &gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_correlation</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Compute pairwise feature correlations</span>
        <span class="n">corr_matrix</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>

        <span class="c1"># Compute correlation of each feature with target variable</span>
        <span class="n">target_corr</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">corrwith</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="p">))</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>

        <span class="c1"># Extract upper triangle to avoid duplicate pairs</span>
        <span class="n">upper_tri</span> <span class="o">=</span> <span class="n">corr_matrix</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">to_drop</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">dropped_details</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">col1</span> <span class="ow">in</span> <span class="n">upper_tri</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col1</span> <span class="ow">in</span> <span class="n">to_drop</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Identify features highly correlated with col1</span>
            <span class="n">correlated_features</span> <span class="o">=</span> <span class="n">upper_tri</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">upper_tri</span><span class="p">[</span><span class="n">col1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_correlation</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">correlated_features</span><span class="p">:</span>
                <span class="c1"># From the correlated group, select the feature most predictive of target</span>
                <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">col1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">correlated_features</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">to_drop</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Keep feature with highest target correlation</span>
                    <span class="n">best_feature</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">target_corr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>

                    <span class="c1"># Mark others for removal</span>
                    <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">candidate</span> <span class="o">!=</span> <span class="n">best_feature</span><span class="p">:</span>
                            <span class="n">to_drop</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>
                            <span class="n">dropped_details</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">candidate</span><span class="si">}</span><span class="s2"> (target_corr=</span><span class="si">{</span><span class="n">target_corr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">candidate</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">) &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;-&gt; kept </span><span class="si">{</span><span class="n">best_feature</span><span class="si">}</span><span class="s2"> (target_corr=</span><span class="si">{</span><span class="n">target_corr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">best_feature</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span>
                            <span class="p">)</span>

        <span class="k">if</span> <span class="n">to_drop</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[FeatureSelector] Stage 1 - Dropping </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">to_drop</span><span class="p">)</span><span class="si">}</span><span class="s2"> correlated features: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">to_drop</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[FeatureSelector] Stage 1 - Details (kept most predictive):&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">detail</span> <span class="ow">in</span> <span class="n">dropped_details</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">detail</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dropped_details</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ... and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dropped_details</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">5</span><span class="si">}</span><span class="s2"> more&quot;</span><span class="p">)</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">to_drop</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[FeatureSelector] Stage 1 - No highly correlated features found&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">X</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_print_correlation_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print diagnostic information about feature correlations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pd.DataFrame</span>
<span class="sd">            Feature matrix.</span>
<span class="sd">        top_n : int, default=10</span>
<span class="sd">            Number of top correlations to display.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">corr_matrix</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>

        <span class="c1"># Extract upper triangle to avoid duplicate pairs</span>
        <span class="n">upper_tri</span> <span class="o">=</span> <span class="n">corr_matrix</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Collect all pairwise correlations</span>
        <span class="n">correlations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">upper_tri</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">upper_tri</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">upper_tri</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                    <span class="n">correlations</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">val</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">correlations</span><span class="p">:</span>
            <span class="n">correlations</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FeatureSelector] Top </span><span class="si">{</span><span class="n">top_n</span><span class="si">}</span><span class="s2"> feature correlations:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">corr_val</span><span class="p">,</span> <span class="n">feat1</span><span class="p">,</span> <span class="n">feat2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">correlations</span><span class="p">[:</span><span class="n">top_n</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">feat1</span><span class="si">}</span><span class="s2"> &lt;-&gt; </span><span class="si">{</span><span class="n">feat2</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">corr_val</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_selected_cols_to_similarity_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selected_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert selected feature column names back to similarity map format.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        selected_cols : list[str]</span>
<span class="sd">            List of selected feature column names (format: &#39;col_{var}_{var}_{similarity}&#39;).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict[str, list[str]]</span>
<span class="sd">            Updated similarity map containing only selected features.</span>
<span class="sd">            Variables with no selected features are excluded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">selected_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">selected_cols</span><span class="p">)</span>
        <span class="n">selected</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Parse feature names to extract (variable, similarity) pairs</span>
        <span class="k">for</span> <span class="n">lcol</span><span class="p">,</span> <span class="n">rcol</span><span class="p">,</span> <span class="n">sim</span> <span class="ow">in</span> <span class="n">SimilarityMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">similarity_map</span><span class="p">):</span>
            <span class="n">col_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;col_</span><span class="si">{</span><span class="n">lcol</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">rcol</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sim</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">selected_set</span><span class="p">:</span>
                <span class="n">selected</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">lcol</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>

        <span class="c1"># Merge in features marked as always_keep</span>
        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">sims</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">always_keep</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">selected</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sims</span><span class="p">)</span>

        <span class="c1"># Preserve original ordering of similarities within each variable</span>
        <span class="n">updated</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">sims</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sims</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">selected</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">set</span><span class="p">())]</span>
            <span class="k">if</span> <span class="n">keep</span><span class="p">:</span>
                <span class="n">updated</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">keep</span>

        <span class="k">return</span> <span class="n">updated</span>

<div class="viewcode-block" id="FeatureSelector.execute">
<a class="viewcode-back" href="../../feature_selection.html#neer_match_utilities.feature_selection.FeatureSelector.execute">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FeatureSelectionResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the two-stage feature selection process.</span>

<span class="sd">        This method performs:</span>
<span class="sd">        1. Builds pairwise similarity features from training data</span>
<span class="sd">        2. Cleans data (removes constant columns, handles missing values)</span>
<span class="sd">        3. **Stage 1** (optional): Correlation-based filtering</span>
<span class="sd">        4. Scales features for regularization</span>
<span class="sd">        5. **Stage 2**: Elastic net cross-validation and feature selection</span>
<span class="sd">        6. Applies coefficient thresholding (if configured)</span>
<span class="sd">        7. Converts selected features back to similarity map format</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        FeatureSelectionResult</span>
<span class="sd">            Object containing the updated similarity map, selected features,</span>
<span class="sd">            coefficients, and metadata about the selection process.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the method is not &#39;elastic_net&#39;, or if no usable features remain</span>
<span class="sd">            after cleaning or correlation filtering, or if there are too few</span>
<span class="sd">            positive examples for cross-validation.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The method prints detailed diagnostic information during execution:</span>
<span class="sd">        - Top feature correlations</span>
<span class="sd">        - Features dropped in Stage 1 (correlation filtering)</span>
<span class="sd">        - Cross-validation progress and best parameters</span>
<span class="sd">        - Features dropped in Stage 2 (elastic net)</span>
<span class="sd">        - Top coefficients by absolute value</span>
<span class="sd">        - Final summary statistics</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; result = selector.execute()</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Selected {len(result.selected_feature_columns)} features&quot;)</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Updated similarity map: {result.updated_similarity_map}&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;elastic_net&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported method=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2">. Only &#39;elastic_net&#39; is implemented.&quot;</span><span class="p">)</span>

        <span class="c1"># Step 1: Build similarity feature dataframe from training data</span>
        <span class="n">smap_obj</span> <span class="o">=</span> <span class="n">SimilarityMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">similarity_map</span><span class="p">)</span>
        <span class="n">feats</span> <span class="o">=</span> <span class="n">SimilarityFeatures</span><span class="p">(</span><span class="n">similarity_map</span><span class="o">=</span><span class="n">smap_obj</span><span class="p">)</span>

        <span class="n">df_train</span> <span class="o">=</span> <span class="n">feats</span><span class="o">.</span><span class="n">pairwise_similarity_dataframe</span><span class="p">(</span>
            <span class="n">left</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">left_train</span><span class="p">,</span>
            <span class="n">right</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">right_train</span><span class="p">,</span>
            <span class="n">matches</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">matches_train</span><span class="p">,</span>
            <span class="n">left_id_col</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_left_col</span><span class="p">,</span>
            <span class="n">right_id_col</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_right_col</span><span class="p">,</span>
            <span class="n">match_col</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">match_col</span><span class="p">,</span>
            <span class="n">matches_id_left</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">matches_id_left</span><span class="p">,</span>
            <span class="n">matches_id_right</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">matches_id_right</span><span class="p">,</span>
            <span class="n">matches_are_indices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">matches_are_indices</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_train</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Expected match label column &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">match_col</span><span class="si">}</span><span class="s2">&#39; in df_train, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;but columns are: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">df_train</span><span class="o">.</span><span class="n">columns</span><span class="p">)[:</span><span class="mi">30</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Step 2: Extract target variable and feature matrix</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">df_train</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">match_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># Verify sufficient positive examples for cross-validation</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not enough positives for cv=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cv</span><span class="si">}</span><span class="s2">: pos=</span><span class="si">{</span><span class="n">pos</span><span class="si">}</span><span class="s2">. Reduce cv or use more labeled matches.&quot;</span><span class="p">)</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">match_col</span><span class="p">])</span>

        <span class="c1"># Filter to similarity feature columns only</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;col_&quot;</span><span class="p">)]]</span>

        <span class="c1"># Ensure all features are numeric</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Handle infinity and missing values</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="c1"># Remove constant columns (no information)</span>
        <span class="n">nunique</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">nunique</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">nunique</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;After cleaning, no usable similarity feature columns remain.&quot;</span><span class="p">)</span>

        <span class="c1"># Diagnostic: print top feature correlations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print_correlation_summary</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># Step 3 (Stage 1): Correlation-based pre-filtering (optional)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drop_correlated_features</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;After correlation filtering, no usable similarity feature columns remain.&quot;</span><span class="p">)</span>

        <span class="c1"># Step 4: Standardize features (required for elastic net)</span>
        <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="n">X_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1"># Step 5 (Stage 2): Elastic net cross-validation</span>
        <span class="c1"># Build parameter grid for exhaustive search</span>
        <span class="n">Cs_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_Cs_grid</span><span class="p">()</span>
        <span class="n">l1_grid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l1_ratios</span><span class="p">)</span>

        <span class="n">skf</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cv</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>
        <span class="n">scorer</span> <span class="o">=</span> <span class="n">get_scorer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scoring</span><span class="p">)</span>

        <span class="c1"># Pre-compute CV folds for reproducibility</span>
        <span class="n">folds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">skf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">fit_and_score</span><span class="p">(</span><span class="n">l1_ratio</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">fold_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Train and evaluate one configuration on one CV fold.&quot;&quot;&quot;</span>
            <span class="n">train_idx</span><span class="p">,</span> <span class="n">val_idx</span> <span class="o">=</span> <span class="n">folds</span><span class="p">[</span><span class="n">fold_idx</span><span class="p">]</span>
            <span class="n">X_tr</span><span class="p">,</span> <span class="n">X_va</span> <span class="o">=</span> <span class="n">X_scaled</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">X_scaled</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span>
            <span class="n">y_tr</span><span class="p">,</span> <span class="n">y_va</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span>

            <span class="n">clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span>
                <span class="n">solver</span><span class="o">=</span><span class="s2">&quot;saga&quot;</span><span class="p">,</span>
                <span class="n">penalty</span><span class="o">=</span><span class="s2">&quot;elasticnet&quot;</span><span class="p">,</span>
                <span class="n">l1_ratio</span><span class="o">=</span><span class="n">l1_ratio</span><span class="p">,</span>
                <span class="n">C</span><span class="o">=</span><span class="n">C</span><span class="p">,</span>
                <span class="n">max_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">,</span>
                <span class="n">tol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span>
                <span class="n">class_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">class_weight</span><span class="p">,</span>
                <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_tr</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">)</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">scorer</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">X_va</span><span class="p">,</span> <span class="n">y_va</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">l1_ratio</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">fold_idx</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">score</span><span class="p">))</span>

        <span class="c1"># Generate all parameter  fold combinations</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[(</span><span class="n">l1</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">l1</span> <span class="ow">in</span> <span class="n">l1_grid</span> <span class="k">for</span> <span class="n">C</span> <span class="ow">in</span> <span class="n">Cs_grid</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">folds</span><span class="p">))]</span>
        <span class="n">total_fits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>

        <span class="c1"># Execute parallel CV with progress bar</span>
        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total_fits</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;[FeatureSelector] CV fits&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;fit&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">tqdm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">with</span> <span class="n">tqdm_joblib</span><span class="p">(</span><span class="n">pbar</span><span class="p">):</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">prefer</span><span class="o">=</span><span class="s2">&quot;processes&quot;</span><span class="p">)(</span>
                <span class="n">delayed</span><span class="p">(</span><span class="n">fit_and_score</span><span class="p">)(</span><span class="n">l1</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">l1</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tasks</span>
            <span class="p">)</span>

        <span class="c1"># Aggregate cross-validation scores</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">l1</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">l1</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
            <span class="n">scores</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="n">sc</span>
            <span class="n">counts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">mean_scores</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">scores</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/</span> <span class="n">counts</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">}</span>
        <span class="n">best_params</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">mean_scores</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">best_l1</span><span class="p">,</span> <span class="n">best_C</span> <span class="o">=</span> <span class="n">best_params</span>
        <span class="n">best_score</span> <span class="o">=</span> <span class="n">mean_scores</span><span class="p">[</span><span class="n">best_params</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[FeatureSelector] Stage 2 - Best params: l1_ratio=</span><span class="si">{</span><span class="n">best_l1</span><span class="si">}</span><span class="s2">, C=</span><span class="si">{</span><span class="n">best_C</span><span class="si">}</span><span class="s2">, score=</span><span class="si">{</span><span class="n">best_score</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Step 6: Refit final model on full training set with best parameters</span>
        <span class="n">final_model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span>
            <span class="n">solver</span><span class="o">=</span><span class="s2">&quot;saga&quot;</span><span class="p">,</span>
            <span class="n">penalty</span><span class="o">=</span><span class="s2">&quot;elasticnet&quot;</span><span class="p">,</span>
            <span class="n">l1_ratio</span><span class="o">=</span><span class="n">best_l1</span><span class="p">,</span>
            <span class="n">C</span><span class="o">=</span><span class="n">best_C</span><span class="p">,</span>
            <span class="n">max_iter</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span>
            <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
            <span class="n">class_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">class_weight</span><span class="p">,</span>
            <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">final_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="n">coef</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">final_model</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="c1"># Step 7: Apply coefficient threshold to select final features</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_coef_threshold</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">coef</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_coef_threshold</span>
            <span class="n">selected_feature_columns</span> <span class="o">=</span> <span class="n">coef</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">dropped_by_threshold</span> <span class="o">=</span> <span class="n">coef</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[FeatureSelector] Stage 2 - Applied min_coef_threshold=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">min_coef_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dropped_by_threshold</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[FeatureSelector] Stage 2 - Dropping </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dropped_by_threshold</span><span class="p">)</span><span class="si">}</span><span class="s2"> features with weak coefficients: </span><span class="si">{</span><span class="n">dropped_by_threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">selected_feature_columns</span> <span class="o">=</span> <span class="n">coef</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">coef</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">dropped_by_elasticnet</span> <span class="o">=</span> <span class="n">coef</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">coef</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">dropped_by_elasticnet</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[FeatureSelector] Stage 2 - Elastic net zeroed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dropped_by_elasticnet</span><span class="p">)</span><span class="si">}</span><span class="s2"> features: </span><span class="si">{</span><span class="n">dropped_by_elasticnet</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FeatureSelector] Summary: features_in=</span><span class="si">{</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> selected_cols=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_feature_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Diagnostic: print top coefficients</span>
        <span class="n">top_coefs</span> <span class="o">=</span> <span class="n">coef</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[FeatureSelector] Top 15 coefficients by absolute value:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">top_coefs</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">feat</span> <span class="ow">in</span> <span class="n">selected_feature_columns</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">marker</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">feat</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">coef</span><span class="p">[</span><span class="n">feat</span><span class="p">]</span><span class="si">:</span><span class="s2">+.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[FeatureSelector] pos=</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="si">}</span><span class="s2"> neg=</span><span class="si">{</span><span class="nb">int</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;features_in=</span><span class="si">{</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> selected_cols=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_feature_columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Step 8: Build metadata dictionary</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
            <span class="s2">&quot;scoring&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scoring</span><span class="p">,</span>
            <span class="s2">&quot;cv&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv</span><span class="p">,</span>
            <span class="s2">&quot;l1_ratios&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_ratios</span><span class="p">,</span>
            <span class="s2">&quot;Cs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Cs</span><span class="p">,</span>
            <span class="s2">&quot;class_weight&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_weight</span><span class="p">,</span>
            <span class="s2">&quot;n_features_in&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="s2">&quot;n_features_selected&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_feature_columns</span><span class="p">)),</span>
        <span class="p">}</span>

        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;did_fallback&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Step 9: Convert selected features back to similarity map format</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_feature_columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Fallback: no features selected, keep original map</span>
            <span class="n">updated</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">similarity_map</span><span class="p">)</span>
            <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;did_fallback&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">updated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_cols_to_similarity_map</span><span class="p">(</span><span class="n">selected_feature_columns</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">updated</span><span class="p">:</span>
                <span class="c1"># Fallback: conversion produced empty map</span>
                <span class="n">updated</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">similarity_map</span><span class="p">)</span>
                <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;did_fallback&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">selected_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">var</span><span class="p">,</span> <span class="n">sim</span><span class="p">)</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">sims</span> <span class="ow">in</span> <span class="n">updated</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">sim</span> <span class="ow">in</span> <span class="n">sims</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[FeatureSelector] did_fallback=</span><span class="si">{</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;did_fallback&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">FeatureSelectionResult</span><span class="p">(</span>
            <span class="n">updated_similarity_map</span><span class="o">=</span><span class="n">updated</span><span class="p">,</span>
            <span class="n">selected_feature_columns</span><span class="o">=</span><span class="n">selected_feature_columns</span><span class="p">,</span>
            <span class="n">selected_pairs</span><span class="o">=</span><span class="n">selected_pairs</span><span class="p">,</span>
            <span class="n">coef_by_feature</span><span class="o">=</span><span class="n">coef</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">abs</span><span class="p">(),</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2026, Pantelis Karapanagiotis, Marius Liebald.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>